<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SB Street Room ‚Äì Roll ‚Äôn Connect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      overflow: hidden;
    }

    a { color: inherit; text-decoration: none; }

    .page-scroll {
      height: 100vh;
      overflow-y: auto;
      padding-bottom: 40px;
    }

    /* HEADER */

    .header {
      position: sticky;
      top: 0;
      left: 0;
      width: 100%;
      padding: 12px 14px;
      background: rgba(8,8,18,0.96);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .hamburger-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.8);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(0,0,0,0.8);
      backdrop-filter: blur(16px);
    }

    .hamburger-button span {
      display: block;
      width: 18px;
      height: 2px;
      background: #fff;
      position: relative;
    }

    .hamburger-button span::before,
    .hamburger-button span::after {
      content: "";
      position: absolute;
      width: 18px;
      height: 2px;
      background: #fff;
      left: 0;
    }

    .hamburger-button span::before { top: -6px; }
    .hamburger-button span::after { top: 6px; }

    .header-title-block {
      display: flex;
      flex-direction: column;
    }

    .header-title {
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    .header-sub {
      font-size: 0.8rem;
      color: #a9bdf8;
      margin-top: 2px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .back-button {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    /* SIDE MENU */

    .side-menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(20px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 2100;
    }

    .side-menu-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .side-menu {
      position: absolute;
      top: 0;
      left: 0;
      width: 260px;
      max-width: 80vw;
      height: 100%;
      background: radial-gradient(circle at top left, rgba(250,250,250,0.1), rgba(10,10,10,0.98));
      box-shadow: 0 0 40px rgba(0,0,0,0.9);
      transform: translateX(-100%);
      transition: transform 0.25s ease;
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
    }

    .side-menu-overlay.active .side-menu {
      transform: translateX(0);
    }

    .side-menu-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .side-menu-subtitle {
      font-size: 0.78rem;
      color: #b3c6ff;
      margin-bottom: 12px;
    }

    .side-menu-nav {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }

    .side-menu-link {
      padding: 9px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #eef3ff;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.05);
      transition: background 0.2s, transform 0.2s, border-color 0.2s;
    }

    .side-menu-link:hover {
      background: rgba(255,255,255,0.12);
      border-color: rgba(255,255,255,0.6);
      transform: translateX(2px);
    }

    /* LAYOUT */

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 14px 40px;
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(260px, 1.1fr);
      gap: 14px;
    }

    @media (max-width: 900px) {
      .page {
        grid-template-columns: 1fr;
      }
    }

    /* LEFT COLUMN ‚Äì CHAT */

    .chat-container {
      border-radius: 18px;
      background: radial-gradient(circle at top, rgba(255,255,255,0.06), rgba(0,0,0,0.95));
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 0 22px rgba(255,255,255,0.09);
      display: flex;
      flex-direction: column;
      min-height: 420px;
      max-height: calc(100vh - 160px);
    }

    .chat-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.18);
    }

    .chat-title-block {
      display: flex;
      flex-direction: column;
    }

    .chat-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .chat-sub {
      font-size: 0.78rem;
      opacity: 0.75;
    }

    .chat-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      overflow: hidden;
      font-size: 0.8rem;
    }

    .chat-toggle button {
      padding: 5px 10px;
      border: none;
      background: transparent;
      color: #fff;
      cursor: pointer;
      min-width: 70px;
    }

    .chat-toggle button.active {
      background: #fff;
      color: #000;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px 10px 6px;
      scroll-behavior: smooth;
    }

    .message {
      margin-bottom: 8px;
      max-width: 80%;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 0.86rem;
      background: rgba(255,255,255,0.07);
      box-shadow: 0 0 12px rgba(0,0,0,0.6);
      position: relative;
    }

    .message.me {
      margin-left: auto;
      background: rgba(255,255,255,0.15);
    }

    .message-meta {
      font-size: 0.7rem;
      opacity: 0.6;
      margin-bottom: 2px;
    }

    .message-text {
      white-space: pre-wrap;
    }

    .message-tag {
      font-size: 0.72rem;
      opacity: 0.75;
      margin-top: 3px;
    }

    .message-target {
      color: #9fd0ff;
    }

    .message-system {
      text-align: center;
      font-size: 0.75rem;
      opacity: 0.7;
      margin: 6px 0;
    }

    .event-card, .spot-card {
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 6px 8px;
      font-size: 0.8rem;
      background: rgba(0,0,0,0.7);
      margin-top: 4px;
    }

    .event-name, .spot-name {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .spot-distance {
      font-size: 0.74rem;
      opacity: 0.8;
    }

    .spot-link, .event-link {
      font-size: 0.74rem;
      color: #a9d4ff;
      text-decoration: underline;
      cursor: pointer;
    }

    .chat-input-row {
      border-top: 1px solid rgba(255,255,255,0.18);
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: rgba(0,0,0,0.92);
      border-radius: 0 0 18px 18px;
    }

    .chat-input-line {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chat-text-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.26);
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 7px 10px;
      font-size: 0.84rem;
    }

    .chat-text-input::placeholder {
      color: rgba(255,255,255,0.4);
    }

    .primary-btn, .ghost-btn {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.3);
      background: #fff;
      color: #000;
      font-size: 0.8rem;
      padding: 6px 10px;
      cursor: pointer;
      white-space: nowrap;
    }

    .ghost-btn {
      background: rgba(0,0,0,0.8);
      color: #fff;
    }

    .emoji-row {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 0.9rem;
    }

    .emoji-btn {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.26);
      background: rgba(0,0,0,0.8);
      color: #fff;
      font-size: 0.8rem;
      padding: 4px 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .emoji-btn span {
      font-size: 0.95rem;
    }

    .recipient-select {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.26);
      background: rgba(0,0,0,0.9);
      color: #fff;
      font-size: 0.8rem;
      padding: 4px 8px;
      max-width: 180px;
    }

    /* RIGHT COLUMN ‚Äì USERS / GROUPS / ACTIONS */

    .side-panel {
      border-radius: 18px;
      background: radial-gradient(circle at top, rgba(255,255,255,0.06), rgba(5,5,5,0.98));
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 0 22px rgba(255,255,255,0.1);
      padding: 10px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 420px;
      max-height: calc(100vh - 160px);
      overflow-y: auto;
    }

    .panel-section {
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      padding: 8px 8px;
      background: rgba(0,0,0,0.85);
    }

    .panel-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .panel-sub {
      font-size: 0.72rem;
      opacity: 0.7;
    }

    .user-list {
      list-style: none;
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .user-item {
      position: relative;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.03);
      font-size: 0.82rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: default;
    }

    .user-name {
      cursor: pointer;
    }

    .user-tag {
      font-size: 0.72rem;
      opacity: 0.7;
      margin-left: 4px;
    }

    .user-cta {
      font-size: 0.74rem;
      opacity: 0.85;
      cursor: pointer;
      text-decoration: underline;
    }

    .profile-tooltip {
      position: absolute;
      left: 0;
      top: 100%;
      margin-top: 4px;
      z-index: 50;
      min-width: 220px;
      border-radius: 10px;
      background: rgba(0,0,0,0.96);
      border: 1px solid rgba(255,255,255,0.22);
      padding: 6px 8px;
      font-size: 0.76rem;
      box-shadow: 0 0 18px rgba(0,0,0,0.8);
      display: none;
    }

    .profile-tooltip.visible {
      display: block;
    }

    .profile-tooltip-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 3px;
    }

    .profile-tooltip-name {
      font-weight: 600;
    }

    .profile-tooltip-btn {
      font-size: 0.72rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      padding: 2px 6px;
      cursor: pointer;
      background: rgba(255,255,255,0.08);
    }

    .profile-tooltip-bio {
      opacity: 0.8;
    }

    .groups-list {
      list-style: none;
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.8rem;
    }

    .group-item {
      padding: 5px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.03);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    .group-label {
      font-weight: 500;
    }

    .group-meta {
      font-size: 0.72rem;
      opacity: 0.75;
    }

    .start-group-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .start-group-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.26);
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 5px 8px;
      font-size: 0.8rem;
    }

    .small-link {
      font-size: 0.76rem;
      color: #a9d4ff;
      text-decoration: underline;
      cursor: pointer;
    }

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .tag-pill {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.26);
      padding: 2px 6px;
      font-size: 0.72rem;
      opacity: 0.8;
    }

    .subtle {
      font-size: 0.72rem;
      opacity: 0.75;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="page-scroll">
    <!-- HEADER -->
    <header class="header">
      <div class="header-left">
        <button class="hamburger-button" id="menuBtn">
          <span></span>
        </button>
        <div class="header-title-block">
          <div class="header-title">SB Street Room</div>
          <div class="header-sub">Public & private street sessions ‚Ä¢ voice + messages</div>
        </div>
      </div>
      <div class="header-right">
        <button class="back-button" id="backBtn">Back</button>
      </div>
    </header>

    <!-- SIDE MENU -->
    <div class="side-menu-overlay" id="menuOverlay">
      <nav class="side-menu">
        <div>
          <div class="side-menu-title">Navigation</div>
          <div class="side-menu-subtitle">Cosmic flow</div>
        </div>
        <div class="side-menu-nav">
          <a class="side-menu-link" href="index.html">Home</a>
          <a class="side-menu-link" href="dashboard.html">Dashboard</a>
          <a class="side-menu-link" href="chatrooms.html">Chatrooms</a>
          <a class="side-menu-link" href="room-sbstreet.html">SB Street Room</a>
          <a class="side-menu-link" href="calendar.html">Calendar</a>
          <a class="side-menu-link" href="events.html">Events</a>
          <a class="side-menu-link" href="find-spots.html">Find Spots</a>
          <a class="side-menu-link" href="spots-map.html">Spots Map</a>
          <a class="side-menu-link" href="marketplace.html">Marketplace</a>
          <a class="side-menu-link" href="notifications.html">Notifications</a>
          <a class="side-menu-link" href="profile.html">Profile</a>
          <a class="side-menu-link" href="settings.html">Settings</a>
        </div>
      </nav>
    </div>

    <!-- MAIN PAGE -->
    <main class="page">
      <!-- LEFT: CHAT AREA -->
      <section class="chat-container">
        <div class="chat-header-row">
          <div class="chat-title-block">
            <div class="chat-title" id="roomLabel">Public SB Street Room</div>
            <div class="chat-sub">Voice messages + regular messages only</div>
          </div>
          <div class="chat-toggle" id="privacyToggle">
            <button data-mode="public" class="active">Public</button>
            <button data-mode="private">Private</button>
          </div>
        </div>

        <div class="chat-messages" id="chatMessages"></div>

        <div class="chat-input-row">
          <div class="chat-input-line">
            <input id="chatInput" class="chat-text-input" type="text" placeholder="Type a message (text only, no files)..." />
            <button id="sendBtn" class="primary-btn">Send</button>
            <button id="voiceBtn" class="ghost-btn" title="Simulate sending a voice message">üéô Voice</button>
          </div>

          <div class="emoji-row">
            <select id="recipientSelect" class="recipient-select">
              <option value="">Send to room (everyone)</option>
            </select>

            <button class="emoji-btn" data-emoji="üòä">
              <span>üòä</span><span>Smiley</span>
            </button>
            <button class="emoji-btn" data-emoji="üòÇ">
              <span>üòÇ</span><span>Laugh</span>
            </button>
            <button class="emoji-btn" data-emoji="üòç">
              <span>üòç</span><span>Love</span>
            </button>
            <button class="emoji-btn" data-emoji="üòò (kiss)">
              <span>üòò</span><span>Kiss</span>
            </button>
            <button class="emoji-btn" data-emoji="ü§ó (hug)">
              <span>ü§ó</span><span>Hug</span>
            </button>
            <button class="emoji-btn" data-emoji="üåπ (rose)">
              <span>üåπ</span><span>Rose</span>
            </button>
          </div>

          <div class="emoji-row">
            <button id="addEventBtn" class="ghost-btn">Add Event from Events</button>
            <button id="addSpotBtn" class="ghost-btn">Add Spot from Find Spots</button>
            <span class="subtle">Events & spots will include details and directions.</span>
          </div>
        </div>
      </section>

      <!-- RIGHT: USERS / GROUPS / ACTIONS -->
      <aside class="side-panel">
        <section class="panel-section">
          <div class="panel-title-row">
            <div>
              <div class="panel-title">People here</div>
              <div class="panel-sub">Hover for profile ‚Ä¢ request private</div>
            </div>
          </div>
          <ul class="user-list" id="userList"></ul>
          <p class="subtle">Hover a name to see a summary and visit profile. Use ‚ÄúPrivate chat‚Äù to request a 1:1.</p>
        </section>

        <section class="panel-section">
          <div class="panel-title-row">
            <div>
              <div class="panel-title">Private groups</div>
              <div class="panel-sub">Live voice together + writing</div>
            </div>
          </div>
          <ul class="groups-list" id="groupsList"></ul>
          <div class="start-group-row">
            <input id="groupNameInput" class="start-group-input" type="text" placeholder="Start your own group..." />
            <button id="startGroupBtn" class="primary-btn">Start</button>
          </div>
          <p class="subtle">
            Private groups simulate shared live voice (phone-style) and include regular text chat.
          </p>
        </section>

        <section class="panel-section">
          <div class="panel-title-row">
            <div class="panel-title">Quick actions</div>
          </div>
          <div class="tag-row">
            <button class="ghost-btn" onclick="location.href='chatrooms.html'">All Chatrooms</button>
            <button class="ghost-btn" onclick="location.href='find-spots.html'">Spots</button>
            <button class="ghost-btn" onclick="location.href='events.html'">Events</button>
          </div>
          <p class="subtle">Use the toggle at the top of the chat to switch between public and private conversations.</p>
        </section>
      </aside>
    </main>
  </div>

  <script>
    // BASIC STATE / CONFIG
    const CURRENT_USER = 'you'; // replace with real auth later
    let mode = 'public'; // 'public' | 'private'
    let currentGroupId = null;

    const users = [
      { username: 'you', display: 'You', bio: 'Street skating, late sessions.', hometown: 'Atlanta', level: 'Creator' },
      { username: 'nova', display: 'Nova', bio: 'Back alleys and stair sets.', hometown: 'LA', level: 'Advanced' },
      { username: 'orbit', display: 'Orbit', bio: 'Street lines and night runs.', hometown: 'NYC', level: 'Intermediate' },
    ];

    let groups = [
      { id: 'g-street-crew', name: 'SB Street Crew', members: ['you','nova'], voiceLive: true },
    ];

    let messages = [];

    // MENU
    const menuBtn = document.getElementById('menuBtn');
    const menuOverlay = document.getElementById('menuOverlay');
    menuBtn.addEventListener('click', () => {
      menuOverlay.classList.toggle('active');
    });
    menuOverlay.addEventListener('click', (e) => {
      if (e.target === menuOverlay) {
        menuOverlay.classList.remove('active');
      }
    });

    // BACK
    document.getElementById('backBtn').addEventListener('click', () => {
      history.back();
    });

    // PRIVACY TOGGLE
    const privacyToggle = document.getElementById('privacyToggle');
    const roomLabel = document.getElementById('roomLabel');

    privacyToggle.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-mode]');
      if (!btn) return;

      const newMode = btn.getAttribute('data-mode');
      if (newMode === mode) return;

      mode = newMode;
      [...privacyToggle.querySelectorAll('button')].forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      if (mode === 'public') {
        roomLabel.textContent = 'Public SB Street Room';
        currentGroupId = null;
      } else {
        roomLabel.textContent = 'Private rooms & groups';
      }
      renderMessages();
    });

    // USERS + HOVER PROFILE TOOLTIP
    const userList = document.getElementById('userList');
    const recipientSelect = document.getElementById('recipientSelect');

    function renderUsers() {
      userList.innerHTML = users.map(u => `
        <li class="user-item" data-username="${u.username}">
          <div>
            <span class="user-name">@${u.username}</span>
            <span class="user-tag">${u.level}</span>
          </div>
          <span class="user-cta" data-action="private-request">Private chat</span>
          <div class="profile-tooltip">
            <div class="profile-tooltip-row">
              <span class="profile-tooltip-name">@${u.username}</span>
              <button class="profile-tooltip-btn" data-action="visit-profile">Visit profile</button>
            </div>
            <div class="profile-tooltip-bio">${u.bio || ''}</div>
            <div class="subtle">From: ${u.hometown || 'Unknown'}</div>
          </div>
        </li>
      `).join('');

      recipientSelect.innerHTML = `
        <option value="">Send to room (everyone)</option>
        ${users
          .filter(u => u.username !== CURRENT_USER)
          .map(u => `<option value="${u.username}">Send to @${u.username}</option>`)
          .join('')}
      `;
    }

    userList.addEventListener('mouseover', (e) => {
      const item = e.target.closest('.user-item');
      if (!item) return;
      const tooltip = item.querySelector('.profile-tooltip');
      tooltip.classList.add('visible');
    });

    userList.addEventListener('mouseout', (e) => {
      const item = e.target.closest('.user-item');
      if (!item) return;
      const tooltip = item.querySelector('.profile-tooltip');
      tooltip.classList.remove('visible');
    });

    userList.addEventListener('click', (e) => {
      const item = e.target.closest('.user-item');
      if (!item) return;
      const username = item.getAttribute('data-username');
      const action = e.target.getAttribute('data-action');

      if (action === 'visit-profile') {
        location.href = 'profile.html';
        return;
      }

      if (action === 'private-request') {
        addSystemMessage(`You requested a private chat with @${username}.`);
        mode = 'private';
        currentGroupId = `dm-${username}`;
        updateToggleUI();
        renderMessages();
      }
    });

    function updateToggleUI() {
      [...privacyToggle.querySelectorAll('button')].forEach(b => {
        const m = b.getAttribute('data-mode');
        b.classList.toggle('active', m === mode);
      });
      roomLabel.textContent = mode === 'public'
        ? 'Public SB Street Room'
        : (currentGroupId ? `Private: ${currentGroupId}` : 'Private rooms & groups');
    }

    // GROUPS
    const groupsList = document.getElementById('groupsList');
    const groupNameInput = document.getElementById('groupNameInput');
    const startGroupBtn = document.getElementById('startGroupBtn');

    function renderGroups() {
      if (!groups.length) {
        groupsList.innerHTML = `<li class="group-item"><span class="group-label">No private groups yet.</span></li>`;
        return;
      }
      groupsList.innerHTML = groups.map(g => `
        <li class="group-item" data-group="${g.id}">
          <div>
            <div class="group-label">${g.name}</div>
            <div class="group-meta">${g.members.length} members ‚Ä¢ Voice: ${g.voiceLive ? 'On' : 'Off'}</div>
          </div>
          <span class="small-link">Join</span>
        </li>
      `).join('');
    }

    groupsList.addEventListener('click', (e) => {
      const item = e.target.closest('.group-item');
      if (!item) return;
      const id = item.getAttribute('data-group');
      currentGroupId = id;
      mode = 'private';
      addSystemMessage(`You joined private group: ${id} (voice on, text enabled).`);
      updateToggleUI();
      renderMessages();
    });

    startGroupBtn.addEventListener('click', () => {
      const name = groupNameInput.value.trim();
      if (!name) return;
      const id = 'g-' + Date.now();
      groups.push({ id, name, members: [CURRENT_USER], voiceLive: true });
      groupNameInput.value = '';
      renderGroups();
      mode = 'private';
      currentGroupId = id;
      addSystemMessage(`You started a private group: ${name}. Live voice + writing ready.`);
      updateToggleUI();
      renderMessages();
    });

    // MESSAGES
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const voiceBtn = document.getElementById('voiceBtn');

    function addSystemMessage(text) {
      messages.push({
        type: 'system',
        text,
        ts: Date.now(),
        mode,
        groupId: currentGroupId || null
      });
      renderMessages();
    }

    function addTextMessage(text) {
      if (!text.trim()) return;
      const to = recipientSelect.value || null;
      messages.push({
        type: 'text',
        from: CURRENT_USER,
        to,
        text: text.trim(),
        ts: Date.now(),
        mode,
        groupId: currentGroupId || null
      });
      renderMessages();
    }

    function addVoiceMessage() {
      const to = recipientSelect.value || null;
      messages.push({
        type: 'voice',
        from: CURRENT_USER,
        to,
        text: '[Voice message]',
        ts: Date.now(),
        mode,
        groupId: currentGroupId || null
      });
      renderMessages();
    }

    function addEmojiMessage(emojiLabel) {
      const to = recipientSelect.value || null;
      messages.push({
        type: 'emoji',
        from: CURRENT_USER,
        to,
        text: emojiLabel,
        ts: Date.now(),
        mode,
        groupId: currentGroupId || null
      });
      renderMessages();
    }

    function addEventToChat(ev) {
      messages.push({
        type: 'event',
        from: CURRENT_USER,
        event: ev,
        ts: Date.now(),
        mode,
        groupId: currentGroupId || null
      });
      renderMessages();
    }

    function addSpotToChat(spot) {
      messages.push({
        type: 'spot',
        from: CURRENT_USER,
        spot,
        ts: Date.now(),
        mode,
        groupId: currentGroupId || null
      });
      renderMessages();
    }

    function visibleMessages() {
      return messages.filter(m => {
        if (m.mode !== mode) return false;
        if (mode === 'private' && currentGroupId) {
          return m.groupId === currentGroupId;
        }
        if (mode === 'private' && !currentGroupId) {
          return false;
        }
        if (mode === 'public') {
          return !m.groupId;
        }
        return true;
      });
    }

    function renderMessages() {
      const list = visibleMessages();
      if (!list.length) {
        chatMessages.innerHTML = `<div class="message-system">No messages yet. Start talking.</div>`;
        return;
      }

      chatMessages.innerHTML = list.map(m => {
        if (m.type === 'system') {
          return `<div class="message-system">${m.text}</div>`;
        }

        const isMe = m.from === CURRENT_USER;
        const sender = m.from ? '@' + m.from : 'system';
        const target = m.to ? '@' + m.to : null;
        const timeStr = new Date(m.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        if (m.type === 'event') {
          const ev = m.event;
          return `
            <div class="message ${isMe ? 'me' : ''}">
              <div class="message-meta">${sender} ‚Ä¢ ${timeStr}</div>
              <div class="message-text">Shared an event:</div>
              <div class="event-card">
                <div class="event-name">${ev.name || 'Event'}</div>
                <div>${ev.date || ''} ${ev.time ? '‚Ä¢ ' + ev.time : ''}</div>
                <div>${ev.location || ''}</div>
                <div><span class="event-link" onclick="location.href='events.html'">View in Events</span></div>
              </div>
            </div>
          `;
        }

        if (m.type === 'spot') {
          const s = m.spot;
          return `
            <div class="message ${isMe ? 'me' : ''}">
              <div class="message-meta">${sender} ‚Ä¢ ${timeStr}</div>
              <div class="message-text">Shared a spot:</div>
              <div class="spot-card">
                <div class="spot-name">${s.name || 'Spot'}</div>
                <div>${s.address || ''}</div>
                <div class="spot-distance">${s.distance ? s.distance + ' away' : ''}</div>
                <div>
                  <span class="spot-link" onclick="location.href='find-spots.html'">Open in Find Spots</span>
                </div>
              </div>
            </div>
          `;
        }

        let tag = '';
        if (m.type === 'voice') {
          tag = `<div class="message-tag">üéô Voice message</div>`;
        } else if (m.type === 'emoji') {
          tag = `<div class="message-tag">Gift: <span>${m.text}</span></div>`;
        }

        const targetText = target
          ? `<span class="message-tag">to <span class="message-target">${target}</span></span>`
          : '';

        return `
          <div class="message ${isMe ? 'me' : ''}">
            <div class="message-meta">${sender} ‚Ä¢ ${timeStr}</div>
            <div class="message-text">${m.text}</div>
            ${tag}
            ${targetText}
          </div>
        `;
      }).join('');

      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // SEND HANDLERS
    sendBtn.addEventListener('click', () => {
      addTextMessage(chatInput.value);
      chatInput.value = '';
    });

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        addTextMessage(chatInput.value);
        chatInput.value = '';
      }
    });

    voiceBtn.addEventListener('click', () => {
      addVoiceMessage();
    });

    // EMOJIS / GIFTS
    document.querySelectorAll('.emoji-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const emojiLabel = btn.getAttribute('data-emoji');
        addEmojiMessage(emojiLabel);
      });
    });

    // EVENTS / SPOTS INJECTION
    const addEventBtn = document.getElementById('addEventBtn');
    const addSpotBtn = document.getElementById('addSpotBtn');

    addEventBtn.addEventListener('click', () => {
      let events = [];
      try {
        events = JSON.parse(localStorage.getItem('rc_events') || '[]');
      } catch (e) {
        events = [];
      }
      const ev = events[0] || {
        name: 'Session from Events page',
        date: '',
        time: '',
        location: ''
      };
      addEventToChat(ev);
    });

    addSpotBtn.addEventListener('click', () => {
      let spots = [];
      try {
        spots = JSON.parse(localStorage.getItem('rc_spots') || '[]');
      } catch (e) {
        spots = [];
      }
      const s = spots[0] || {
        name: 'Spot from Find Spots',
        address: '',
        distance: ''
      };
      addSpotToChat(s);
    });

    // INIT
    renderUsers();
    renderGroups();
    addSystemMessage('Welcome to SB Street Room. You can send voice messages, regular messages, emojis, and gifts.');
  </script>
</body>
</html>
