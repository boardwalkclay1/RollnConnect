<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cruising Chat â€” Roll â€™n Connect</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Theme: black & white glowing with subtle chrome */
    :root{
      --bg:#050507; --panel:#0b0d11; --muted:#9aa3b2; --white:#fff;
      --glass:rgba(255,255,255,0.03); --accent:#fff;
      --bubble-bg:rgba(255,255,255,0.04); --bubble-me:#ffffff;
      --max-width:1100px;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#07070a);color:var(--white);font-family:Inter,system-ui,Segoe UI,Arial;-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--max-width);margin:18px auto;padding:18px;display:grid;grid-template-columns:320px 1fr 360px;gap:18px}
    /* Left sidebar */
    .sidebar{background:var(--panel);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 40px rgba(0,0,0,0.6)}
    .brand{font-weight:900;font-size:1.1rem}
    .small{color:var(--muted);font-size:0.9rem;margin-top:6px}
    .nav{margin-top:14px;display:flex;flex-direction:column;gap:8px}
    .nav a{color:var(--white);text-decoration:none;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02)}
    /* Center chat */
    .chat-panel{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;height:78vh}
    .chat-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .room-title{font-weight:900}
    .messages{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:12px}
    /* Message bubble layout */
    .msg-row{display:flex;gap:10px;align-items:flex-end}
    .msg-row.me{flex-direction:row-reverse}
    .avatar{width:44px;height:44px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,0.04);flex:0 0 44px}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .bubble{max-width:72%;padding:10px 12px;border-radius:14px;background:var(--bubble-bg);position:relative;color:var(--white);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .bubble.me{background:linear-gradient(180deg,#fff,#eee);color:#000}
    .meta{font-size:0.78rem;color:var(--muted);margin-bottom:6px}
    .time{font-size:0.72rem;color:var(--muted);margin-top:6px}
    .username{font-weight:800;cursor:pointer}
    /* Emoji rendering */
    .emoji-inline{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;margin:0 4px;vertical-align:middle}
    .emoji-circle{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:50%;margin-right:8px}
    /* Composer */
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(255,255,255,0.02);align-items:center}
    .input{flex:1;padding:12px;border-radius:12px;border:none;background:rgba(255,255,255,0.03);color:var(--white);min-height:44px;resize:none}
    .send-btn{background:linear-gradient(90deg,#fff,#ddd);color:#000;padding:10px 14px;border-radius:12px;border:none;font-weight:800;cursor:pointer}
    .small-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--white);padding:8px;border-radius:10px;cursor:pointer}
    /* Emoji picker panel */
    .emoji-panel{display:flex;flex-direction:column;gap:8px;padding:10px;background:rgba(0,0,0,0.45);border-radius:12px;border:1px solid rgba(255,255,255,0.03);max-height:320px;overflow:auto}
    .emoji-tabs{display:flex;gap:8px;margin-bottom:8px}
    .emoji-tab{padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
    .emoji-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(36px,1fr));gap:6px}
    .emoji-tile{display:flex;align-items:center;justify-content:center;padding:6px;border-radius:8px;cursor:pointer}
    /* DM panel (right) */
    .dm-panel{background:var(--panel);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);height:78vh;display:flex;flex-direction:column}
    .dm-header{display:flex;align-items:center;gap:10px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .dm-list{margin-top:12px;display:flex;flex-direction:column;gap:8px;overflow:auto}
    .dm-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;cursor:pointer}
    .dm-item:hover{background:rgba(255,255,255,0.02)}
    /* message effects */
    .bubble.slam{animation:slamAnim .45s cubic-bezier(.2,.8,.2,1)}
    @keyframes slamAnim{0%{transform:scale(.85);opacity:.6}60%{transform:scale(1.08);opacity:1}100%{transform:scale(1)}}
    .bubble.reveal{opacity:0;transform:translateY(10px);animation:revealAnim .45s ease forwards}
    @keyframes revealAnim{to{opacity:1;transform:translateY(0)}}
    .bubble.quiet{opacity:.6;filter:grayscale(.2);transform:scale(.98)}
    /* small helpers */
    .muted{color:var(--muted)}
    .tag{font-size:0.8rem;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02)}
    /* responsive */
    @media (max-width:1100px){ .wrap{grid-template-columns:1fr; padding:12px} .dm-panel{display:none} .sidebar{display:none} }
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Cruising chatroom">
    <!-- Left sidebar -->
    <aside class="sidebar" aria-label="Navigation">
      <div class="brand">ROLL â€™N CONNECT</div>
      <div class="small">Cruising â€” Chill rides & routes</div>
      <nav class="nav" aria-label="Primary">
        <a href="longboard.html">â† Back to Longboard</a>
        <a href="room-dancing.html">Dancing</a>
        <a href="room-downhill.html">Downhill</a>
        <a href="chatrooms.html">All Chatrooms</a>
      </nav>
      <div style="margin-top:14px">
        <div class="tag">Message effects: slam, reveal, quiet</div>
      </div>
    </aside>

    <!-- Center chat -->
    <section class="chat-panel" aria-labelledby="room-heading">
      <div class="chat-header">
        <div>
          <div id="room-heading" class="room-title">Cruising</div>
          <div class="small muted">Tap a username to open a private discussion. Avatars and profile info are automatic.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="openEmoji" class="small-btn" title="Open emoji picker">ğŸ˜Š Emoji</button>
          <button id="shareLoc" class="small-btn" title="Share location">ğŸ“ Share</button>
        </div>
      </div>

      <div id="messages" class="messages" aria-live="polite"></div>

      <div style="display:none;margin-bottom:8px" id="emojiPanel" class="emoji-panel" aria-hidden="true">
        <div class="emoji-tabs" role="tablist">
          <div class="emoji-tab" data-tab="all">All</div>
          <div class="emoji-tab" data-tab="skater">Skater Packs</div>
          <div class="emoji-tab" data-tab="hearts">Hearts</div>
          <div class="emoji-tab" data-tab="books">Books</div>
          <div class="emoji-tab" data-tab="elements">Elements</div>
        </div>
        <div id="emojiGrid" class="emoji-grid" role="grid"></div>
      </div>

      <div class="composer" role="region" aria-label="Message composer">
        <textarea id="input" class="input" placeholder="Write a message... (press Enter to send)"></textarea>
        <select id="effect" class="small-btn" title="Message effect">
          <option value="normal">Normal</option>
          <option value="slam">Slam</option>
          <option value="reveal">Reveal</option>
          <option value="quiet">Quiet</option>
        </select>
        <button id="send" class="send-btn">Send</button>
      </div>
    </section>

    <!-- Right DM panel -->
    <aside class="dm-panel" aria-label="Direct messages">
      <div class="dm-header">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:44px;height:44px;border-radius:50%;overflow:hidden;background:rgba(255,255,255,0.03)" id="myAvatar"><img src="" alt="" style="width:100%;height:100%;object-fit:cover"></div>
          <div>
            <div id="myName" style="font-weight:800"></div>
            <div class="muted" id="myHandle"></div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:800">Direct Messages</div>
        <div class="dm-list" id="dmList" role="list"></div>
      </div>
    </aside>
  </div>

<script>
/* Cruising chatroom script
   - Profile: localStorage.rc_profile = { id, displayName, avatarUrl, handle }
   - Room messages: localStorage.rc_chat_cruising
   - DM messages: localStorage.rc_dm_<otherId>
   - TTL: 24 hours
*/

const ROOM_KEY = 'rc_chat_cruising';
const PROFILE_KEY = 'rc_profile';
const TTL = 24 * 60 * 60 * 1000;
const CLEANUP_INTERVAL = 30 * 60 * 1000;

const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('send');
const effectEl = document.getElementById('effect');
const emojiPanel = document.getElementById('emojiPanel');
const emojiGrid = document.getElementById('emojiGrid');
const openEmojiBtn = document.getElementById('openEmoji');
const shareLocBtn = document.getElementById('shareLoc');
const dmListEl = document.getElementById('dmList');
const myAvatarEl = document.querySelector('#myAvatar img');
const myNameEl = document.getElementById('myName');
const myHandleEl = document.getElementById('myHandle');

let profile = ensureProfile();
let messages = loadMessages();
let dmIndex = {}; // map otherId -> last message preview

// --- Emoji data (expanded, categorized) ---
const EMOJI_PACKS = {
  skater: ['ğŸ›¹','ğŸ›¼','ğŸ›´','ğŸ›¹ğŸ›¹','ğŸ›¼âœ¨','ğŸ›¹ğŸ”¥','ğŸ›¹ğŸ’¨','ğŸ›¹ğŸ¤˜'],
  hearts: ['â¤ï¸','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ’–','ğŸ’˜','ğŸ’'],
  books: ['ğŸ“š','ğŸ“–','ğŸ“˜','ğŸ“—','ğŸ“•','ğŸ““','ğŸ“’','ğŸ“”','ğŸ“™'],
  elements: ['ğŸ”¥','ğŸ’§','ğŸŒªï¸','ğŸŒŠ','ğŸŒ±','âš¡','â„ï¸','ğŸŒ','ğŸŒ™'],
  all: [] // will be filled
};
// flatten into all
EMOJI_PACKS.all = [...new Set(Object.values(EMOJI_PACKS).flat())];

// --- Utilities ---
function uid(){ return 'm_' + Math.random().toString(36).slice(2,9); }
function now(){ return Date.now(); }
function saveRoom(msgs){ localStorage.setItem(ROOM_KEY, JSON.stringify(msgs)); }
function loadMessages(){
  try{ const raw = localStorage.getItem(ROOM_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ return []; }
}
function ensureProfile(){
  try{
    const raw = localStorage.getItem(PROFILE_KEY);
    if(raw){
      const p = JSON.parse(raw);
      if(p && p.id) return p;
    }
  }catch(e){}
  // create a temporary profile
  const id = 'u_' + Math.random().toString(36).slice(2,9);
  const p = { id, displayName: 'Rider ' + id.slice(-4), avatarUrl: defaultAvatar(id), handle: 'rider' + id.slice(-4) };
  localStorage.setItem(PROFILE_KEY, JSON.stringify(p));
  return p;
}
function defaultAvatar(id){
  // simple SVG data URL avatar (monochrome) for placeholder
  const bg = encodeURIComponent('#111');
  const fg = encodeURIComponent('#fff');
  const txt = encodeURIComponent((profile && profile.displayName ? profile.displayName[0] : 'R'));
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='${bg}'/><text x='50%' y='55%' font-size='90' fill='${fg}' text-anchor='middle' font-family='Arial' font-weight='700'>${txt}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}
function formatTime(ts){ const d = new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

// --- Cleanup old messages ---
function cleanup(){
  const cutoff = now() - TTL;
  // room
  messages = loadMessages().filter(m => m.ts >= cutoff);
  saveRoom(messages);
  // DMs
  for(const k in localStorage){
    if(k.startsWith('rc_dm_')){
      try{
        const arr = JSON.parse(localStorage.getItem(k) || '[]');
        const filtered = arr.filter(m => m.ts >= cutoff);
        if(filtered.length !== arr.length) localStorage.setItem(k, JSON.stringify(filtered));
      }catch(e){}
    }
  }
}

// --- Rendering ---
function renderMessages(){
  messagesEl.innerHTML = '';
  const msgs = loadMessages().sort((a,b)=>a.ts - b.ts);
  for(const m of msgs){
    const isMe = m.senderId === profile.id;
    const row = document.createElement('div');
    row.className = 'msg-row' + (isMe ? ' me' : '');
    // avatar
    const av = document.createElement('div'); av.className = 'avatar';
    const img = document.createElement('img'); img.src = m.avatarUrl || defaultAvatar(m.senderId); img.alt = m.senderName;
    av.appendChild(img);
    // bubble
    const bubble = document.createElement('div');
    bubble.className = 'bubble' + (isMe ? ' me' : '') + (m.effect ? ' ' + m.effect : '');
    // meta (username clickable)
    const meta = document.createElement('div'); meta.className = 'meta';
    const uname = document.createElement('span'); uname.className = 'username'; uname.textContent = m.senderName;
    uname.dataset.userid = m.senderId;
    uname.addEventListener('click', onOpenDM);
    meta.appendChild(uname);
    meta.appendChild(document.createTextNode(' Â· ' + formatTime(m.ts)));
    // body
    const body = document.createElement('div'); body.className = 'body';
    body.innerHTML = renderMessageBody(m);
    // time small
    const time = document.createElement('div'); time.className = 'time muted'; time.textContent = new Date(m.ts).toLocaleString();
    bubble.appendChild(meta);
    bubble.appendChild(body);
    if(m.meta && m.meta.location){
      const loc = document.createElement('div'); loc.className = 'muted'; loc.style.marginTop = '8px';
      const a = document.createElement('a'); a.href = `/find-spots.html?lat=${m.meta.location.lat}&lng=${m.meta.location.lng}`; a.textContent = 'Open in Find Spots'; a.style.color = 'inherit'; a.style.fontWeight = '700';
      loc.appendChild(a);
      bubble.appendChild(loc);
    }
    bubble.appendChild(time);
    // assemble
    if(isMe){
      row.appendChild(bubble);
      row.appendChild(av);
    } else {
      row.appendChild(av);
      row.appendChild(bubble);
    }
    messagesEl.appendChild(row);
  }
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function renderMessageBody(m){
  // render text with emoji metadata if present
  let html = escapeHtml(m.text || '');
  if(Array.isArray(m.emojis) && m.emojis.length){
    // append emoji tiles
    const tiles = m.emojis.map(e => `<span class="emoji-circle" style="background:${e.color||'transparent'}">${escapeHtml(e.char)}</span>`).join('');
    html += '<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px">' + tiles + '</div>';
  }
  return html;
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// --- Send message ---
function sendMessage(text, effect='normal', meta=null, emojis=[]){
  const msg = {
    id: uid(),
    senderId: profile.id,
    senderName: profile.displayName,
    avatarUrl: profile.avatarUrl,
    text: text || '',
    ts: now(),
    effect,
    emojis,
    meta
  };
  const arr = loadMessages();
  arr.push(msg);
  localStorage.setItem(ROOM_KEY, JSON.stringify(arr));
  renderMessages();
  indexDMPreview(msg);
}

// --- Emoji picker behavior ---
let currentTab = 'all';
function openEmojiPanel(){
  emojiPanel.style.display = emojiPanel.style.display === 'none' ? 'flex' : 'none';
  emojiPanel.setAttribute('aria-hidden', emojiPanel.style.display === 'none');
  populateEmojiGrid(currentTab);
}
function populateEmojiGrid(tab){
  emojiGrid.innerHTML = '';
  const list = (tab === 'all') ? EMOJI_PACKS.all : (EMOJI_PACKS[tab] || []);
  for(const ch of list){
    const tile = document.createElement('div'); tile.className = 'emoji-tile';
    tile.textContent = ch;
    tile.addEventListener('click', ()=> {
      // insert emoji into input
      inputEl.value += ch;
      inputEl.focus();
    });
    emojiGrid.appendChild(tile);
  }
}

// --- Share location ---
function shareLocation(){
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  shareLocBtn.disabled = true; shareLocBtn.textContent = 'â€¦';
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude:lat, longitude:lng} = pos.coords;
    sendMessage('Shared a location', effectEl.value, { location:{lat,lng} }, []);
    shareLocBtn.disabled = false; shareLocBtn.textContent = 'ğŸ“ Share';
  }, err=>{
    alert('Location denied or unavailable'); shareLocBtn.disabled = false; shareLocBtn.textContent = 'ğŸ“ Share';
  }, {enableHighAccuracy:false,timeout:10000});
}

// --- DM handling ---
function onOpenDM(e){
  const otherId = e.currentTarget.dataset.userid;
  if(!otherId || otherId === profile.id) return;
  openDMPanel(otherId);
}
function openDMPanel(otherId){
  // open a simple modal-like view in the right panel by creating or focusing a DM item
  const key = 'rc_dm_' + otherId;
  // ensure DM list shows this user
  renderDMList();
  // open DM conversation in a simple prompt for now (inline)
  const otherProfile = getProfileById(otherId) || { id: otherId, displayName: 'User', avatarUrl: defaultAvatar(otherId) };
  const text = prompt(`Direct message to ${otherProfile.displayName}. Type your message:`);
  if(text && text.trim()){
    const msg = { id: uid(), senderId: profile.id, senderName: profile.displayName, avatarUrl: profile.avatarUrl, text: text.trim(), ts: now(), effect: 'normal', emojis: [], meta: null };
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    arr.push(msg);
    localStorage.setItem(key, JSON.stringify(arr));
    // update DM preview
    indexDMPreview(msg, otherId);
    alert('Message saved to local DM (localStorage). This is a local-only DM in this prototype.');
  }
}
function getProfileById(id){
  // in a real app you'd fetch; here we check localStorage for profiles saved under rc_profile_<id>
  try{
    const raw = localStorage.getItem('rc_profile_' + id);
    if(raw) return JSON.parse(raw);
  }catch(e){}
  return null;
}
function indexDMPreview(msg, otherId){
  // update dmIndex for right panel preview
  const other = otherId || (msg.senderId === profile.id ? (msg.meta && msg.meta.to) : msg.senderId);
  dmIndex[other] = { text: msg.text, ts: msg.ts, name: msg.senderName, avatar: msg.avatarUrl };
  renderDMList();
}
function renderDMList(){
  dmListEl.innerHTML = '';
  // gather keys
  const keys = [];
  for(const k in localStorage){
    if(k.startsWith('rc_dm_')) keys.push(k);
  }
  // also include any indexed previews
  for(const id in dmIndex){
    const k = 'rc_dm_' + id;
    if(!keys.includes(k)) keys.push(k);
  }
  // render each
  keys.sort();
  for(const k of keys){
    const otherId = k.replace('rc_dm_','');
    const arr = JSON.parse(localStorage.getItem(k) || '[]');
    const last = arr.length ? arr[arr.length-1] : null;
    const preview = dmIndex[otherId] || last || { text:'No messages', ts:0, name:otherId, avatar: defaultAvatar(otherId) };
    const item = document.createElement('div'); item.className = 'dm-item';
    const av = document.createElement('div'); av.className = 'avatar'; const img = document.createElement('img'); img.src = preview.avatar || defaultAvatar(otherId); av.appendChild(img);
    const txt = document.createElement('div'); txt.innerHTML = `<div style="font-weight:800">${escapeHtml(preview.name || otherId)}</div><div class="muted" style="font-size:0.9rem">${escapeHtml(preview.text.slice(0,40))}</div>`;
    item.appendChild(av); item.appendChild(txt);
    item.addEventListener('click', ()=> openDMConversation(otherId));
    dmListEl.appendChild(item);
  }
}
function openDMConversation(otherId){
  // show a quick conversation view (prompt-based for prototype)
  const key = 'rc_dm_' + otherId;
  const arr = JSON.parse(localStorage.getItem(key) || '[]');
  const history = arr.map(m => `${m.senderName}: ${m.text}`).join('\n');
  const reply = prompt(`Conversation with ${otherId}:\n\n${history}\n\nType reply:`);
  if(reply && reply.trim()){
    const msg = { id: uid(), senderId: profile.id, senderName: profile.displayName, avatarUrl: profile.avatarUrl, text: reply.trim(), ts: now(), effect: 'normal', emojis: [], meta: null };
    arr.push(msg);
    localStorage.setItem(key, JSON.stringify(arr));
    indexDMPreview(msg, otherId);
    alert('Reply saved locally.');
  }
}

// --- Profile UI ---
function renderMyProfile(){
  myAvatarEl.src = profile.avatarUrl || defaultAvatar(profile.id);
  myNameEl.textContent = profile.displayName;
  myHandleEl.textContent = '@' + (profile.handle || profile.id);
}

// --- Input handlers ---
sendBtn.addEventListener('click', ()=> {
  const text = inputEl.value.trim();
  if(!text) return;
  // parse emojis from input (simple: any emoji char appended)
  const emojis = []; // for now, we don't parse complex emoji metadata; user can use emoji picker to add
  sendMessage(text, effectEl.value, null, emojis);
  inputEl.value = '';
});
inputEl.addEventListener('keydown', e=> {
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
});

// emoji panel
openEmojiBtn.addEventListener('click', openEmojiPanel);
emojiPanel.addEventListener('click', e=>{
  if(e.target.classList.contains('emoji-tab')){
    currentTab = e.target.dataset.tab;
    populateEmojiGrid(currentTab);
  } else if(e.target.classList.contains('emoji-tile')){
    // insert emoji into input
    inputEl.value += e.target.textContent;
    inputEl.focus();
  }
});

// share location
shareLocBtn.addEventListener('click', shareLocation);

// initial render
cleanup();
renderMessages();
renderMyProfile();
renderDMList();
populateEmojiGrid('all');

// periodic cleanup
setInterval(()=>{ cleanup(); renderMessages(); renderDMList(); }, CLEANUP_INTERVAL);

// Dev helper: expose functions for console testing
window.__rc = { profile, sendMessage, loadMessages, cleanup, openDMPanel };

</script>
</body>
</html>
