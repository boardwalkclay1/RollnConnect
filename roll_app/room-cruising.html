<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cruising Chat â€” Roll â€™n Connect</title>
<style>
  :root{
    --bg:#050507; --panel:#0b0d11; --muted:#9aa3b2; --white:#fff;
    --glass:rgba(255,255,255,0.03); --accent:#fff;
    --bubble-bg:rgba(255,255,255,0.04); --bubble-me:#ffffff;
    --max-width:1300px; --card-radius:14px;
    --accent-color:#00d1ff;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#07070a);color:var(--white);font-family:Inter,system-ui,Segoe UI,Arial;-webkit-font-smoothing:antialiased}
  .wrap{max-width:var(--max-width);margin:18px auto;padding:18px;display:grid;grid-template-columns:280px 1fr 320px;gap:18px;align-items:start}
  /* Left */
  .sidebar{background:var(--panel);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 40px rgba(0,0,0,0.6)}
  .brand{font-weight:900;font-size:1.1rem}
  .small{color:var(--muted);font-size:0.9rem;margin-top:6px}
  .nav{margin-top:14px;display:flex;flex-direction:column;gap:8px}
  .nav a{color:var(--white);text-decoration:none;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02)}
  /* Center chat */
  .chat-panel{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;height:78vh;position:relative}
  .chat-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .room-title{font-weight:900}
  .messages{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg,transparent,rgba(255,255,255,0.01))}
  /* Message bubble layout */
  .msg-row{display:flex;gap:10px;align-items:flex-end}
  .msg-row.me{flex-direction:row-reverse}
  .avatar{width:44px;height:44px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,0.04);flex:0 0 44px}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .bubble{max-width:72%;padding:10px 12px;border-radius:14px;background:var(--bubble-bg);position:relative;color:var(--white);box-shadow:0 8px 30px rgba(0,0,0,0.6);word-break:break-word}
  .bubble.me{background:linear-gradient(180deg,#fff,#eee);color:#000}
  .meta{font-size:0.78rem;color:var(--muted);margin-bottom:6px;display:flex;gap:8px;align-items:center}
  .time{font-size:0.72rem;color:var(--muted);margin-top:6px}
  .username{font-weight:800;cursor:pointer}
  /* Emoji rendering */
  .emoji-inline{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;margin:0 4px;vertical-align:middle}
  .emoji-circle{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:50%;margin-right:8px}
  /* Composer */
  .composer{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(255,255,255,0.02);align-items:center}
  .input{flex:1;padding:12px;border-radius:12px;border:none;background:rgba(255,255,255,0.03);color:var(--white);min-height:48px;resize:none}
  .send-btn{background:linear-gradient(90deg,#fff,#ddd);color:#000;padding:10px 14px;border-radius:12px;border:none;font-weight:800;cursor:pointer}
  .small-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--white);padding:8px;border-radius:10px;cursor:pointer}
  /* Emoji picker panel */
  .emoji-panel{display:none;flex-direction:column;gap:8px;padding:10px;background:rgba(0,0,0,0.45);border-radius:12px;border:1px solid rgba(255,255,255,0.03);max-height:320px;overflow:auto;position:absolute;right:20px;bottom:80px;z-index:40}
  .emoji-tabs{display:flex;gap:8px;margin-bottom:8px}
  .emoji-tab{padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
  .emoji-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(36px,1fr));gap:6px}
  .emoji-tile{display:flex;align-items:center;justify-content:center;padding:6px;border-radius:8px;cursor:pointer;font-size:18px}
  .emoji-color{width:18px;height:18px;border-radius:50%;display:inline-block;margin-left:6px;border:1px solid rgba(0,0,0,0.2)}
  /* Fonts & style controls */
  .controls{display:flex;gap:8px;align-items:center}
  select, input[type="color"]{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--white);padding:8px;border-radius:8px}
  /* Members list (right) */
  .members{background:var(--panel);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);height:78vh;display:flex;flex-direction:column}
  .members h4{margin:0 0 8px 0}
  .member-list{overflow:auto;flex:1;display:flex;flex-direction:column;gap:8px}
  .member-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;cursor:default}
  .member-item:hover{background:rgba(255,255,255,0.02)}
  .member-name{font-weight:700;cursor:pointer}
  .member-actions{margin-left:auto;display:flex;gap:6px}
  .profile-pop{position:fixed;background:var(--panel);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(0,0,0,0.6);z-index:50;min-width:220px}
  /* Notification center */
  .notif-center{background:var(--panel);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);height:78vh;display:flex;flex-direction:column}
  .notif-header{display:flex;align-items:center;justify-content:space-between}
  .notif-list{margin-top:12px;overflow:auto;flex:1;display:flex;flex-direction:column;gap:8px}
  .notif-item{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;gap:8px;align-items:flex-start}
  .notif-actions{margin-left:auto;display:flex;gap:6px}
  /* message effects */
  .bubble.slam{animation:slamAnim .45s cubic-bezier(.2,.8,.2,1)}
  @keyframes slamAnim{0%{transform:scale(.85);opacity:.6}60%{transform:scale(1.08);opacity:1}100%{transform:scale(1)}}
  .bubble.reveal{opacity:0;transform:translateY(10px);animation:revealAnim .45s ease forwards}
  @keyframes revealAnim{to{opacity:1;transform:translateY(0)}}
  .bubble.quiet{opacity:.55;filter:grayscale(.3);transform:scale(.98)}
  /* fonts preview */
  .font-sample{display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-left:6px}
  /* responsive */
  @media (max-width:1100px){ .wrap{grid-template-columns:1fr; padding:12px} .members,.notif-center,.sidebar{display:none} .emoji-panel{right:10px;left:10px} }
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Cruising chatroom">
    <!-- Left sidebar -->
    <aside class="sidebar" aria-label="Navigation">
      <div class="brand">ROLL â€™N CONNECT</div>
      <div class="small">Cruising â€” Chill rides & routes</div>
      <nav class="nav" aria-label="Primary">
        <a href="longboard.html">â† Back to Longboard</a>
        <a href="room-dancing.html">Dancing</a>
        <a href="room-downhill.html">Downhill</a>
        <a href="chatrooms.html">All Chatrooms</a>
      </nav>
      <div style="margin-top:14px">
        <div class="small">Tip: Hover members to preview profile. Click name to request a private chat or "I wanna skate".</div>
      </div>
    </aside>

    <!-- Center chat -->
    <section class="chat-panel" aria-labelledby="room-heading">
      <div class="chat-header">
        <div>
          <div id="room-heading" class="room-title">Cruising</div>
          <div class="small muted">Instagram-style bubbles, rich emoji, message effects, location sharing, and private requests.</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div class="controls" title="Font and emoji settings">
            <label class="muted" style="font-size:0.85rem">Font</label>
            <select id="fontSelect" aria-label="Choose message font">
              <option value="Inter,system-ui,Arial">Inter (Default)</option>
              <option value="'Segoe UI',system-ui,Arial">Segoe UI</option>
              <option value="'Helvetica Neue',Helvetica,Arial">Helvetica</option>
              <option value="'Georgia',serif">Georgia</option>
              <option value="'Courier New',monospace">Courier</option>
            </select>
            <label class="muted" style="font-size:0.85rem">Emoji Pack</label>
            <select id="emojiPackSelect" aria-label="Choose emoji pack">
              <option value="all">All</option>
              <option value="skater">Skater</option>
              <option value="hearts">Hearts</option>
              <option value="books">Books</option>
              <option value="elements">Elements</option>
            </select>
          </div>

          <button id="openEmoji" class="small-btn" title="Open emoji picker">ğŸ˜Š</button>
          <button id="openNotifs" class="small-btn" title="Open notifications">ğŸ”” <span id="notifCount" style="margin-left:6px;font-weight:800"></span></button>
        </div>
      </div>

      <div id="messages" class="messages" aria-live="polite"></div>

      <div id="emojiPanel" class="emoji-panel" aria-hidden="true">
        <div class="emoji-tabs" role="tablist">
          <div class="emoji-tab" data-tab="all">All</div>
          <div class="emoji-tab" data-tab="skater">Skater</div>
          <div class="emoji-tab" data-tab="hearts">Hearts</div>
          <div class="emoji-tab" data-tab="books">Books</div>
          <div class="emoji-tab" data-tab="elements">Elements</div>
        </div>
        <div id="emojiGrid" class="emoji-grid" role="grid"></div>
      </div>

      <div class="composer" role="region" aria-label="Message composer">
        <textarea id="input" class="input" placeholder="Write a message... (Enter to send)"></textarea>
        <select id="effect" class="small-btn" title="Message effect">
          <option value="normal">Normal</option>
          <option value="slam">Slam</option>
          <option value="reveal">Reveal</option>
          <option value="quiet">Quiet</option>
        </select>
        <button id="shareLoc" class="small-btn" title="Share location">ğŸ“</button>
        <button id="send" class="send-btn">Send</button>
      </div>
    </section>

    <!-- Members list -->
    <aside class="members" aria-label="Members">
      <h4>Members</h4>
      <div class="member-list" id="memberList" role="list"></div>
      <div style="margin-top:12px">
        <div style="font-weight:800">Quick actions</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="joinBtn" class="small-btn">Join Room</button>
          <button id="leaveBtn" class="small-btn">Leave Room</button>
        </div>
      </div>
    </aside>

    <!-- Notification center -->
    <aside class="notif-center" aria-label="Notifications">
      <div class="notif-header">
        <div style="font-weight:800">Notifications</div>
        <div><button id="clearNotifs" class="small-btn">Clear</button></div>
      </div>
      <div class="notif-list" id="notifList" role="list"></div>
    </aside>
  </div>

<script>
/* Advanced Cruising Chat â€” fully functional local prototype
   Storage keys:
     - rc_profile : current user profile {id,displayName,avatarUrl,handle}
     - rc_profiles_<id> : optional other user profiles
     - rc_members_cruising : array of members
     - rc_chat_cruising : array of messages
     - rc_dm_<otherId> : array of DM messages (local)
     - rc_notifs_cruising : array of notifications
   TTL: 24 hours
*/

const ROOM_KEY = 'rc_chat_cruising';
const PROFILE_KEY = 'rc_profile';
const MEMBERS_KEY = 'rc_members_cruising';
const NOTIF_KEY = 'rc_notifs_cruising';
const TTL = 24 * 60 * 60 * 1000;
const CLEANUP_INTERVAL = 30 * 60 * 1000;

/* DOM */
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('send');
const effectEl = document.getElementById('effect');
const emojiPanel = document.getElementById('emojiPanel');
const emojiGrid = document.getElementById('emojiGrid');
const openEmojiBtn = document.getElementById('openEmoji');
const shareLocBtn = document.getElementById('shareLoc');
const memberListEl = document.getElementById('memberList');
const notifListEl = document.getElementById('notifList');
const openNotifsBtn = document.getElementById('openNotifs');
const notifCountEl = document.getElementById('notifCount');
const fontSelect = document.getElementById('fontSelect');
const emojiPackSelect = document.getElementById('emojiPackSelect');

/* Emoji packs (expanded) */
const EMOJI_PACKS = {
  skater: ['ğŸ›¹','ğŸ›¼','ğŸ›´','ğŸ›¹ğŸ’¨','ğŸ›¹ğŸ”¥','ğŸ›¹ğŸ¤˜','ğŸ›¼âœ¨','ğŸ›¼ğŸµ','ğŸ›¹ğŸ','ğŸ›¼â¤ï¸','ğŸ›¼ğŸ›¼','ğŸ›¹ğŸ›¼'],
  hearts: ['â¤ï¸','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—'],
  books: ['ğŸ“š','ğŸ“–','ğŸ“˜','ğŸ“—','ğŸ“•','ğŸ““','ğŸ“’','ğŸ“”','ğŸ“™','ğŸ“šâœ¨','ğŸ“šğŸ“–'],
  elements: ['ğŸ”¥','ğŸ’§','ğŸŒªï¸','ğŸŒŠ','ğŸŒ±','âš¡','â„ï¸','ğŸŒ','ğŸŒ™','ğŸŒŸ','ğŸŒˆ','ğŸŒ«ï¸'],
  faces: ['ğŸ˜€','ğŸ˜…','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜','ğŸ˜','ğŸ¤™','ğŸ¤˜','ğŸ¤Ÿ','ğŸ¤©','ğŸ˜´'],
  gestures: ['ğŸ‘','ğŸ‘Š','âœŒï¸','ğŸ‘','ğŸ™','ğŸ¤','ğŸ¤œ','ğŸ¤›'],
  all: []
};
EMOJI_PACKS.all = [...new Set(Object.values(EMOJI_PACKS).flat())];

/* Utilities */
function uid(){ return 'id_' + Math.random().toString(36).slice(2,9); }
function now(){ return Date.now(); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* Profile management */
let profile = ensureProfile();
function ensureProfile(){
  try{
    const raw = localStorage.getItem(PROFILE_KEY);
    if(raw){ const p = JSON.parse(raw); if(p && p.id) { addMember(p); return p; } }
  }catch(e){}
  // create ephemeral profile
  const id = 'u_' + Math.random().toString(36).slice(2,8);
  const p = { id, displayName: 'Rider ' + id.slice(-4), avatarUrl: generateAvatarDataUrl(id, true), handle: 'rider' + id.slice(-4) };
  localStorage.setItem(PROFILE_KEY, JSON.stringify(p));
  addMember(p);
  return p;
}
function generateAvatarDataUrl(id, useLetter){
  const bg = '#111';
  const fg = '#fff';
  const txt = encodeURIComponent(useLetter ? (profile && profile.displayName ? profile.displayName[0] : id[0]) : id[0]);
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='${bg}'/><text x='50%' y='55%' font-size='90' fill='${fg}' text-anchor='middle' font-family='Arial' font-weight='700'>${txt}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

/* Members */
function loadMembers(){ try{ const raw = localStorage.getItem(MEMBERS_KEY); return raw ? JSON.parse(raw) : []; }catch(e){return [];} }
function saveMembers(list){ localStorage.setItem(MEMBERS_KEY, JSON.stringify(list)); }
function addMember(p){
  const list = loadMembers();
  if(!list.find(m=>m.id===p.id)){
    list.push({ id:p.id, displayName:p.displayName, avatarUrl:p.avatarUrl, handle:p.handle });
    saveMembers(list);
  } else {
    // update if changed
    const idx = list.findIndex(m=>m.id===p.id);
    list[idx] = { id:p.id, displayName:p.displayName, avatarUrl:p.avatarUrl, handle:p.handle };
    saveMembers(list);
  }
}
function removeMember(id){
  const list = loadMembers().filter(m=>m.id!==id);
  saveMembers(list);
}

/* Notifications */
function loadNotifs(){ try{ const raw = localStorage.getItem(NOTIF_KEY); return raw ? JSON.parse(raw) : []; }catch(e){return [];} }
function saveNotifs(arr){ localStorage.setItem(NOTIF_KEY, JSON.stringify(arr)); updateNotifCount(); }
function pushNotif(n){
  const arr = loadNotifs();
  arr.unshift(n);
  saveNotifs(arr);
  renderNotifs();
}
function updateNotifCount(){
  const arr = loadNotifs();
  notifCountEl.textContent = arr.length ? arr.length : '';
}

/* Messages */
function loadMessages(){ try{ const raw = localStorage.getItem(ROOM_KEY); return raw ? JSON.parse(raw) : []; }catch(e){return [];} }
function saveMessages(arr){ localStorage.setItem(ROOM_KEY, JSON.stringify(arr)); }

/* TTL cleanup */
function cleanup(){
  const cutoff = now() - TTL;
  // room messages
  const msgs = loadMessages().filter(m => m.ts >= cutoff);
  saveMessages(msgs);
  // DMs
  for(const k in localStorage){
    if(k.startsWith('rc_dm_')){
      try{
        const arr = JSON.parse(localStorage.getItem(k) || '[]');
        const filtered = arr.filter(m => m.ts >= cutoff);
        if(filtered.length !== arr.length) localStorage.setItem(k, JSON.stringify(filtered));
      }catch(e){}
    }
  }
  // notifs
  const nots = loadNotifs().filter(n => n.ts >= cutoff);
  saveNotifs(nots);
}

/* Rendering messages */
function renderMessages(){
  messagesEl.innerHTML = '';
  const msgs = loadMessages().sort((a,b)=>a.ts - b.ts);
  for(const m of msgs){
    const isMe = m.senderId === profile.id;
    const row = document.createElement('div');
    row.className = 'msg-row' + (isMe ? ' me' : '');
    // avatar
    const av = document.createElement('div'); av.className = 'avatar';
    const img = document.createElement('img'); img.src = m.avatarUrl || generateAvatarDataUrl(m.senderId); img.alt = m.senderName;
    av.appendChild(img);
    // bubble
    const bubble = document.createElement('div');
    bubble.className = 'bubble' + (isMe ? ' me' : '') + (m.effect ? ' ' + m.effect : '');
    bubble.style.fontFamily = fontSelect.value;
    // meta
    const meta = document.createElement('div'); meta.className = 'meta';
    const uname = document.createElement('span'); uname.className = 'username'; uname.textContent = m.senderName;
    uname.dataset.userid = m.senderId;
    uname.addEventListener('click', ()=> requestDM(m.senderId));
    uname.addEventListener('mouseenter', (e)=> showProfilePop(e, m.senderId));
    uname.addEventListener('mouseleave', hideProfilePop);
    meta.appendChild(uname);
    const timeSpan = document.createElement('span'); timeSpan.className = 'muted'; timeSpan.textContent = formatTime(m.ts);
    meta.appendChild(timeSpan);
    // body
    const body = document.createElement('div'); body.className = 'body';
    body.innerHTML = renderMessageBody(m);
    bubble.appendChild(meta);
    bubble.appendChild(body);
    if(m.meta && m.meta.location){
      const loc = document.createElement('div'); loc.className = 'muted'; loc.style.marginTop = '8px';
      const a = document.createElement('a'); a.href = `/find-spots.html?lat=${m.meta.location.lat}&lng=${m.meta.location.lng}`; a.textContent = 'Open in Find Spots'; a.style.color = 'inherit'; a.style.fontWeight = '700';
      loc.appendChild(a);
      bubble.appendChild(loc);
    }
    const time = document.createElement('div'); time.className = 'time muted'; time.textContent = new Date(m.ts).toLocaleString();
    bubble.appendChild(time);
    // assemble
    if(isMe){
      row.appendChild(bubble);
      row.appendChild(av);
    } else {
      row.appendChild(av);
      row.appendChild(bubble);
    }
    messagesEl.appendChild(row);
  }
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* Render message body with emoji tiles */
function renderMessageBody(m){
  let html = escapeHtml(m.text || '');
  if(Array.isArray(m.emojis) && m.emojis.length){
    const tiles = m.emojis.map(e => `<span class="emoji-circle" style="background:${e.color||'transparent'}">${escapeHtml(e.char)}</span>`).join('');
    html += '<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px">' + tiles + '</div>';
  }
  return `<div style="font-family:${fontSelect.value};">${html}</div>`;
}

/* Render members */
function renderMembers(){
  memberListEl.innerHTML = '';
  const members = loadMembers().slice().sort((a,b)=>a.displayName.localeCompare(b.displayName));
  for(const m of members){
    const item = document.createElement('div'); item.className = 'member-item';
    const av = document.createElement('div'); av.className = 'avatar'; const img = document.createElement('img'); img.src = m.avatarUrl || generateAvatarDataUrl(m.id); av.appendChild(img);
    const txt = document.createElement('div'); txt.innerHTML = `<div class="member-name" data-id="${m.id}">${escapeHtml(m.displayName)}</div><div class="muted" style="font-size:0.85rem">@${escapeHtml(m.handle||m.id)}</div>`;
    const actions = document.createElement('div'); actions.className = 'member-actions';
    const dmBtn = document.createElement('button'); dmBtn.className = 'small-btn'; dmBtn.textContent = 'DM'; dmBtn.addEventListener('click', ()=> requestDM(m.id));
    const skateBtn = document.createElement('button'); skateBtn.className = 'small-btn'; skateBtn.textContent = 'I wanna skate'; skateBtn.addEventListener('click', ()=> requestSkate(m.id));
    actions.appendChild(dmBtn); actions.appendChild(skateBtn);
    item.appendChild(av); item.appendChild(txt); item.appendChild(actions);
    // hover profile summary
    const nameEl = txt.querySelector('.member-name');
    nameEl.addEventListener('mouseenter', (e)=> showProfilePop(e, m.id));
    nameEl.addEventListener('mouseleave', hideProfilePop);
    memberListEl.appendChild(item);
  }
}

/* Profile popup */
let profilePop = null;
function showProfilePop(e, memberOrId){
  hideProfilePop();
  const member = (typeof memberOrId === 'string') ? getMemberById(memberOrId) : memberOrId;
  if(!member) return;
  profilePop = document.createElement('div'); profilePop.className = 'profile-pop';
  profilePop.innerHTML = `<div style="display:flex;gap:10px;align-items:center">
    <div style="width:56px;height:56px;border-radius:50%;overflow:hidden"><img src="${member.avatarUrl||generateAvatarDataUrl(member.id)}" style="width:100%;height:100%;object-fit:cover"></div>
    <div>
      <div style="font-weight:800">${escapeHtml(member.displayName)}</div>
      <div class="muted">@${escapeHtml(member.handle||member.id)}</div>
      <div style="margin-top:8px;color:var(--muted);font-size:0.9rem">Quick actions: DM Â· I wanna skate</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="small-btn" id="popDM">Request DM</button>
        <button class="small-btn" id="popSkate">I wanna skate</button>
      </div>
    </div>
  </div>`;
  document.body.appendChild(profilePop);
  const rect = e.target.getBoundingClientRect();
  profilePop.style.left = Math.min(window.innerWidth - 240, rect.right + 12) + 'px';
  profilePop.style.top = Math.max(8, rect.top - 6) + 'px';
  document.getElementById('popDM').addEventListener('click', ()=> { requestDM(member.id); hideProfilePop(); });
  document.getElementById('popSkate').addEventListener('click', ()=> { requestSkate(member.id); hideProfilePop(); });
}
function hideProfilePop(){ if(profilePop && profilePop.parentNode) profilePop.parentNode.removeChild(profilePop); profilePop = null; }

/* Notifications rendering */
function loadNotifs(){ try{ const raw = localStorage.getItem(NOTIF_KEY); return raw ? JSON.parse(raw) : []; }catch(e){return [];} }
function saveNotifs(arr){ localStorage.setItem(NOTIF_KEY, JSON.stringify(arr)); updateNotifCount(); }
function pushNotifObj(n){ const arr = loadNotifs(); arr.unshift(n); saveNotifs(arr); renderNotifs(); }
function renderNotifs(){
  notifListEl.innerHTML = '';
  const nots = loadNotifs();
  for(const n of nots){
    const item = document.createElement('div'); item.className = 'notif-item';
    const left = document.createElement('div'); left.style.display='flex'; left.style.gap='8px';
    const av = document.createElement('div'); av.className='avatar'; const img = document.createElement('img'); img.src = n.fromAvatar || generateAvatarDataUrl(n.fromId); av.appendChild(img);
    const txt = document.createElement('div'); txt.innerHTML = `<div style="font-weight:800">${escapeHtml(n.title)}</div><div class="muted" style="font-size:0.9rem">${escapeHtml(n.body)}</div><div class="muted" style="font-size:0.75rem;margin-top:6px">${new Date(n.ts).toLocaleString()}</div>`;
    left.appendChild(av); left.appendChild(txt);
    const actions = document.createElement('div'); actions.className='notif-actions';
    const accept = document.createElement('button'); accept.className='small-btn'; accept.textContent='Accept'; accept.addEventListener('click', ()=> { handleNotifAccept(n); });
    const dismiss = document.createElement('button'); dismiss.className='small-btn'; dismiss.textContent='Dismiss'; dismiss.addEventListener('click', ()=> { dismissNotif(n.id); });
    actions.appendChild(accept); actions.appendChild(dismiss);
    item.appendChild(left); item.appendChild(actions);
    notifListEl.appendChild(item);
  }
  updateNotifCount();
}
function handleNotifAccept(n){
  // Accepting a skate request or DM request: create a confirmation message in chat
  if(n.type === 'skate_request'){
    sendMessage(`${profile.displayName} accepted ${n.fromName}'s skate request.`, 'normal', null, []);
  } else if(n.type === 'dm_request'){
    sendMessage(`${profile.displayName} accepted ${n.fromName}'s DM request.`, 'normal', null, []);
  }
  dismissNotif(n.id);
}
function dismissNotif(id){
  const arr = loadNotifs().filter(n=>n.id!==id);
  saveNotifs(arr);
  renderNotifs();
}

/* Send message */
function sendMessage(text, effect='normal', meta=null, emojis=[]){
  const msg = {
    id: uid(),
    senderId: profile.id,
    senderName: profile.displayName,
    avatarUrl: profile.avatarUrl,
    text: text || '',
    ts: now(),
    effect,
    emojis,
    meta
  };
  const arr = loadMessages();
  arr.push(msg);
  saveMessages(arr);
  renderMessages();
}

/* Share location */
function shareLocation(){
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  shareLocBtn.disabled = true; shareLocBtn.textContent = 'â€¦';
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude:lat, longitude:lng} = pos.coords;
    sendMessage('Shared a location', effectEl.value, { location:{lat,lng} }, []);
    shareLocBtn.disabled = false; shareLocBtn.textContent = 'ğŸ“';
  }, err=>{
    alert('Location denied or unavailable'); shareLocBtn.disabled = false; shareLocBtn.textContent = 'ğŸ“';
  }, {enableHighAccuracy:false,timeout:10000});
}

/* DM request (local prototype) */
function requestDM(otherId){
  const other = getMemberById(otherId);
  if(!other){ alert('User not found'); return; }
  const notif = { id: uid(), ts: now(), title: 'DM request', body: `${profile.displayName} wants to DM you.`, fromId: profile.id, fromName: profile.displayName, fromAvatar: profile.avatarUrl, type:'dm_request' };
  pushNotifObj(notif);
  alert('DM request sent (local prototype). It appears in your Notification Center.');
}

/* I wanna skate */
function requestSkate(otherId){
  const other = getMemberById(otherId);
  if(!other){ alert('User not found'); return; }
  const notif = { id: uid(), ts: now(), title: 'I wanna skate', body: `${profile.displayName} wants to skate with you.`, fromId: profile.id, fromName: profile.displayName, fromAvatar: profile.avatarUrl, type:'skate_request' };
  pushNotifObj(notif);
  alert('Skate request sent (local prototype). It appears in your Notification Center.');
}

/* Helpers */
function getMemberById(id){ return loadMembers().find(m=>m.id===id); }
function formatTime(ts){ const d = new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

/* Emoji picker */
function populateEmojiGrid(tab){
  emojiGrid.innerHTML = '';
  const list = (tab === 'all') ? EMOJI_PACKS.all : (EMOJI_PACKS[tab] || []);
  for(const ch of list){
    const tile = document.createElement('div'); tile.className = 'emoji-tile'; tile.textContent = ch;
    tile.addEventListener('click', ()=> { inputEl.value += ch; inputEl.focus(); });
    emojiGrid.appendChild(tile);
  }
}

/* Seed demo members and messages if empty */
function seedDemo(){
  if(loadMembers().length === 0){
    const demo = [
      { id:'u_alex', displayName:'Alex', avatarUrl:generateAvatarDataUrl('u_alex'), handle:'alex' },
      { id:'u_bree', displayName:'Bree', avatarUrl:generateAvatarDataUrl('u_bree'), handle:'bree' },
      { id:'u_chris', displayName:'Chris', avatarUrl:generateAvatarDataUrl('u_chris'), handle:'chris' },
      profile
    ];
    saveMembers(demo);
  }
  if(loadMessages().length === 0){
    const demoMsgs = [
      { id:uid(), senderId:'u_alex', senderName:'Alex', avatarUrl:generateAvatarDataUrl('u_alex'), text:'Morning cruise route: boardwalk to pier', ts:now()-3600*1000, effect:'normal', emojis:[], meta:null },
      { id:uid(), senderId:'u_bree', senderName:'Bree', avatarUrl:generateAvatarDataUrl('u_bree'), text:'I love that route â¤ï¸', ts:now()-3500*1000, effect:'reveal', emojis:[{char:'â¤ï¸',color:'#ff6b6b'}], meta:null },
      { id:uid(), senderId:profile.id, senderName:profile.displayName, avatarUrl:profile.avatarUrl, text:'Anyone down for a sunset lap?', ts:now()-1800*1000, effect:'slam', emojis:[], meta:null }
    ];
    saveMessages(demoMsgs);
  }
  if(loadNotifs().length === 0){
    saveNotifs([{ id:uid(), ts:now()-2000*1000, title:'Welcome', body:'You joined Cruising chat. Hover members to preview profiles.', fromId:'system', fromName:'System', fromAvatar:'' }]);
  }
}

/* Render everything */
function renderAll(){
  renderMessages();
  renderMembers();
  renderNotifs();
  updateNotifCount();
}

/* Event bindings */
sendBtn.addEventListener('click', ()=> {
  const text = inputEl.value.trim();
  if(!text) return;
  sendMessage(text, effectEl.value, null, []);
  inputEl.value = '';
});
inputEl.addEventListener('keydown', e=> {
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
});
openEmojiBtn.addEventListener('click', ()=> {
  emojiPanel.style.display = emojiPanel.style.display === 'flex' ? 'none' : 'flex';
  emojiPanel.setAttribute('aria-hidden', emojiPanel.style.display === 'none');
  populateEmojiGrid(emojiPackSelect.value || 'all');
});
emojiPanel.addEventListener('click', e=>{
  if(e.target.classList.contains('emoji-tab')){
    const tab = e.target.dataset.tab;
    populateEmojiGrid(tab);
  } else if(e.target.classList.contains('emoji-tile')){
    inputEl.value += e.target.textContent;
    inputEl.focus();
  }
});
emojiPackSelect.addEventListener('change', ()=> populateEmojiGrid(emojiPackSelect.value));
shareLocBtn.addEventListener('click', shareLocation);
document.getElementById('clearNotifs').addEventListener('click', ()=> { saveNotifs([]); renderNotifs(); });
document.getElementById('joinBtn').addEventListener('click', ()=> { addMember(profile); renderMembers(); });
document.getElementById('leaveBtn').addEventListener('click', ()=> { removeMember(profile.id); renderMembers(); });

/* Periodic cleanup */
setInterval(()=>{ cleanup(); renderAll(); }, CLEANUP_INTERVAL);

/* Initial setup */
EMOJI_PACKS.all = [...new Set(Object.values(EMOJI_PACKS).flat())];
seedDemo();
populateEmojiGrid('all');
renderAll();

/* Expose for debugging */
window.__rc = { profile, sendMessage, loadMessages, loadMembers, loadNotifs };

/* small helper to show profile pop on username click in messages */
function showProfilePop(e, id){
  const member = getMemberById(id);
  if(member) showProfilePopAtElement(e.target, member);
}
function showProfilePopAtElement(target, member){
  hideProfilePop();
  profilePop = document.createElement('div'); profilePop.className = 'profile-pop';
  profilePop.innerHTML = `<div style="display:flex;gap:10px;align-items:center">
    <div style="width:56px;height:56px;border-radius:50%;overflow:hidden"><img src="${member.avatarUrl||generateAvatarDataUrl(member.id)}" style="width:100%;height:100%;object-fit:cover"></div>
    <div>
      <div style="font-weight:800">${escapeHtml(member.displayName)}</div>
      <div class="muted">@${escapeHtml(member.handle||member.id)}</div>
      <div style="margin-top:8px;color:var(--muted);font-size:0.9rem">Click to request DM or "I wanna skate"</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="small-btn" id="popDM">Request DM</button>
        <button class="small-btn" id="popSkate">I wanna skate</button>
      </div>
    </div>
  </div>`;
  document.body.appendChild(profilePop);
  const rect = target.getBoundingClientRect();
  profilePop.style.left = Math.min(window.innerWidth - 260, rect.right + 12) + 'px';
  profilePop.style.top = Math.max(8, rect.top - 6) + 'px';
  document.getElementById('popDM').addEventListener('click', ()=> { requestDM(member.id); hideProfilePop(); });
  document.getElementById('popSkate').addEventListener('click', ()=> { requestSkate(member.id); hideProfilePop(); });
}
function hideProfilePop(){ if(profilePop && profilePop.parentNode) profilePop.parentNode.removeChild(profilePop); profilePop = null; }

</script>
</body>
</html>
