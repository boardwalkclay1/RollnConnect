<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Cosmic Calendar ‚Äì Roll ‚Äôn Connect</title>

<style>
/* GLOBAL */
body {
  background:#000;
  color:#fff;
  margin:0;
  padding:0;
  font-family:'Inter',sans-serif;
  overflow-x:hidden;
  min-height:100vh;
}

/* STARFIELDS */
.stars1,.stars2,.stars3 {
  position:fixed; inset:0;
  background:url('styles/stars-white.png') repeat;
  z-index:-3;
  pointer-events:none;
}
.stars1{opacity:.55;animation:drift1 140s linear infinite;}
.stars2{opacity:.35;animation:drift2 200s linear infinite;}
.stars3{opacity:.2; animation:drift3 260s linear infinite;}

@keyframes drift1{from{background-position:0 0;}to{background-position:0 -5000px;}}
@keyframes drift2{from{background-position:0 0;}to{background-position:-4000px -2000px;}}
@keyframes drift3{from{background-position:0 0;}to{background-position:3000px 4000px;}}

/* BURGER */
.hamburger {
  position:fixed;
  top:25px;
  left:25px;
  width:40px;
  height:30px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  cursor:pointer;
  z-index:99999;
}
.hamburger span {
  height:4px;
  width:100%;
  background:#fff;
  border-radius:4px;
  box-shadow:0 0 12px rgba(255,255,255,0.9);
  transition:0.3s;
}
.hamburger.active span:nth-child(1){transform:translateY(13px) rotate(45deg);}
.hamburger.active span:nth-child(2){opacity:0;}
.hamburger.active span:nth-child(3){transform:translateY(-13px) rotate(-45deg);}

/* SIDEBAR */
.sidebar {
  position:fixed;
  top:0;
  left:-260px;
  width:260px;
  height:100vh;
  background:rgba(10,10,20,0.92);
  backdrop-filter:blur(25px);
  border-right:1px solid rgba(255,255,255,0.25);
  padding:26px 20px;
  box-shadow:10px 0 40px rgba(0,0,0,0.7);
  transition:0.35s ease;
  z-index:99998;
}
.sidebar.open { left:0; }

.sidebar-header {
  text-align:center;
  margin-bottom:24px;
}
.sidebar-header h2 {
  font-size:1.4rem;
  text-shadow:0 0 20px #fff;
}

.sidebar a {
  display:block;
  color:#fff;
  text-decoration:none;
  padding:10px 14px;
  margin-bottom:10px;
  border-radius:10px;
  background:rgba(255,255,255,0.05);
  box-shadow:0 0 10px rgba(255,255,255,0.15);
  transition:0.25s;
}
.sidebar a:hover {
  background:rgba(255,255,255,0.2);
  transform:translateX(5px);
  box-shadow:0 0 18px rgba(255,255,255,0.4);
}

/* MAIN WRAPPER */
.cosmic-wrapper {
  padding:120px 20px 80px;
  max-width:1400px;
  margin:0 auto;
}

/* GIANT CALENDAR SHELL */
.calendar-shell {
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(25px);
  border-radius:26px;
  box-shadow:0 0 60px rgba(255,255,255,0.3);
  padding:28px;
  position:relative;
  z-index:20;
}

/* HEADER */
.section-title {
  font-size:3.4rem;
  text-align:center;
  text-shadow:0 0 40px #fff;
  margin-bottom:8px;
}
.section-subtitle {
  text-align:center;
  opacity:0.85;
  margin-bottom:24px;
}

/* GIANT CALENDAR LAYOUT: GRID + DETAILS STACKED */
.calendar-layout {
  display:flex;
  flex-direction:column;
  gap:20px;
}

/* MONTH VIEW */
.month-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:14px;
}
.month-name {
  font-size:1.6rem;
  font-weight:600;
}
.month-nav button {
  background:rgba(255,255,255,0.15);
  border:none;
  color:#fff;
  padding:8px 12px;
  border-radius:999px;
  cursor:pointer;
  margin-left:8px;
}
.month-nav button:hover {
  background:#fff;
  color:#000;
}

/* BIG GRID */
.weekdays,
.calendar-grid {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
}
.weekday {
  text-align:center;
  font-size:0.9rem;
  opacity:0.7;
  padding-bottom:4px;
}
.day-cell {
  min-height:110px;
  background:rgba(0,0,0,0.55);
  border-radius:14px;
  padding:8px;
  cursor:pointer;
  position:relative;
  overflow:hidden;
  border:1px solid rgba(255,255,255,0.12);
}
.day-cell.other-month {
  opacity:0.35;
}
.day-cell.today {
  border-color:rgba(255,255,255,0.9);
  box-shadow:0 0 18px rgba(255,255,255,0.9);
}
.day-cell.selected {
  border-color:#4fc3ff;
  box-shadow:0 0 18px rgba(79,195,255,0.9);
}
.day-number {
  font-size:1rem;
  font-weight:600;
}

/* small tags inside day cells */
.day-tags {
  margin-top:6px;
  font-size:0.75rem;
  line-height:1.2;
}
.day-tag-pill {
  display:inline-block;
  margin:0 4px 2px 0;
  padding:2px 6px;
  border-radius:999px;
  font-size:0.7rem;
  background:rgba(255,255,255,0.16);
}
.day-tag-pill.public { border:1px solid #4fff81; }
.day-tag-pill.private { border:1px solid #ff4f81; }
.day-tag-pill.groups { border:1px solid #4fc3ff; }

/* RIGHT / BELOW PANEL */
.details-panel {
  background:rgba(0,0,0,0.70);
  border-radius:20px;
  padding:18px 18px 22px;
  box-shadow:0 0 35px rgba(0,0,0,0.9);
}
.right-heading {
  font-size:1.2rem;
  margin-bottom:4px;
}
.right-date-label {
  font-size:0.95rem;
  opacity:0.88;
  margin-bottom:10px;
}

/* FILTERS + ACTIONS */
.filters-row {
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:10px;
}
.filter-pill {
  padding:5px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.35);
  background:rgba(0,0,0,0.3);
  font-size:0.75rem;
  cursor:pointer;
  opacity:0.75;
}
.filter-pill.active {
  background:#fff;
  color:#000;
  box-shadow:0 0 14px rgba(255,255,255,0.9);
  opacity:1;
}
.add-btn {
  margin-left:auto;
  padding:7px 13px;
  border-radius:999px;
  border:none;
  background:#fff;
  color:#000;
  font-size:0.8rem;
  cursor:pointer;
}
.add-btn:hover {
  box-shadow:0 0 16px rgba(255,255,255,0.9);
}

/* DAY LIST */
.day-list {
  max-height:260px;
  overflow-y:auto;
  margin-bottom:10px;
}
.day-empty {
  opacity:0.7;
  font-size:0.9rem;
  padding:8px 4px;
}
.calendar-item {
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
  background:rgba(255,255,255,0.10);
  box-shadow:0 0 18px rgba(0,0,0,0.7);
  font-size:0.85rem;
}
.calendar-item-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
}
.calendar-item-type {
  font-size:0.75rem;
  opacity:0.75;
}
.calendar-item-privacy {
  font-size:0.7rem;
  padding:2px 7px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.4);
}
.calendar-item a {
  color:#fff;
  text-decoration:underline;
}

/* EDIT/DELETE */
.item-actions {
  margin-top:6px;
}
.item-actions button {
  padding:4px 9px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-size:0.7rem;
  margin-right:6px;
}
.item-actions .edit-btn { background:#fff; color:#000; }
.item-actions .delete-btn { background:rgba(255,80,80,0.20); color:#ff9a9a; }

/* INLINE EDITOR */
.editor {
  margin-top:8px;
  padding:8px;
  border-radius:10px;
  background:rgba(0,0,0,0.5);
}
.editor-row {
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.editor input,
.editor select {
  flex:1 1 100%;
  background:rgba(255,255,255,0.15);
  border:none;
  border-radius:8px;
  padding:6px 8px;
  color:#fff;
  font-size:0.8rem;
}
.editor input::placeholder {
  color:rgba(255,255,255,0.6);
}
.editor-actions {
  margin-top:6px;
}
.editor-actions button {
  padding:5px 10px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-size:0.75rem;
  margin-right:6px;
}
.editor .save-btn { background:#fff; color:#000; }
.editor .cancel-btn { background:rgba(255,255,255,0.2); color:#fff; }

/* SHARE PANEL */
.share-panel {
  margin-top:10px;
  border-top:1px dashed rgba(255,255,255,0.3);
  padding-top:8px;
  font-size:0.8rem;
}
.share-panel input {
  width:100%;
  margin-top:4px;
  background:rgba(255,255,255,0.15);
  border:none;
  border-radius:8px;
  padding:6px 8px;
  color:#fff;
}
.share-panel button {
  margin-top:6px;
  padding:5px 10px;
  border-radius:999px;
  border:none;
  background:#fff;
  color:#000;
  font-size:0.75rem;
  cursor:pointer;
}

/* FLOATING BUBBLES */
.bubble {
  position:fixed;
  width:160px;
  height:160px;
  border-radius:50%;
  background:rgba(255,255,255,0.10);
  backdrop-filter:blur(18px);
  box-shadow:0 0 40px rgba(255,255,255,0.40);
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  color:#fff;
  text-decoration:none;
  font-size:0.9rem;
  padding:10px;
  z-index:10; /* behind giant calendar shell (20), above stars */
  transition:transform 0.2s;
}
.bubble:hover {
  transform:scale(1.08);
}
</style>
</head>

<body>

<!-- STARFIELDS -->
<div class="stars1"></div>
<div class="stars2"></div>
<div class="stars3"></div>

<!-- BURGER -->
<div id="hamburger" class="hamburger">
  <span></span><span></span><span></span>
</div>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar">
  <div class="sidebar-header"><h2>Menu</h2></div>
  <a href="dashboard.html">Dashboard</a>
  <a href="profile.html">My Profile</a>
  <a href="profile-edit.html">Edit Profile</a>
  <a href="chatrooms.html">Chatrooms</a>
  <a href="events.html">Events</a>
  <a href="find-spots.html">Find Spots</a>
  <a href="calendar.html">My Calendar</a>
</div>

<!-- FLOATING COSMIC BUBBLES (CHAT, PROFILE, SPOTS, DASHBOARD) -->
<a href="chatrooms.html" class="bubble" id="bubbleChat">Chatrooms</a>
<a href="profile.html" class="bubble" id="bubbleProfile">Profile</a>
<a href="find-spots.html" class="bubble" id="bubbleSpots">Find Spots</a>
<a href="dashboard.html" class="bubble" id="bubbleDashboard">Dashboard</a>

<!-- MAIN CONTENT: ONE GIANT CALENDAR -->
<div class="cosmic-wrapper">
  <div class="calendar-shell">
    <h1 class="section-title">My Cosmic Calendar</h1>
    <p class="section-subtitle">
      One giant, editable calendar with events, lessons, spots, groups, and sharing.
    </p>

    <div class="calendar-layout">

      <!-- BIG MONTH GRID -->
      <div>
        <div class="month-header">
          <div class="month-name" id="monthName"></div>
          <div class="month-nav">
            <button id="prevMonthBtn">‚üµ Prev</button>
            <button id="nextMonthBtn">Next ‚ü∂</button>
          </div>
        </div>

        <div class="weekdays">
          <div class="weekday">Sun</div>
          <div class="weekday">Mon</div>
          <div class="weekday">Tue</div>
          <div class="weekday">Wed</div>
          <div class="weekday">Thu</div>
          <div class="weekday">Fri</div>
          <div class="weekday">Sat</div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>

      <!-- DAY DETAILS + EDITING + SHARING BELOW -->
      <div class="details-panel">
        <div class="right-heading">Day Details</div>
        <div class="right-date-label" id="selectedDateLabel"></div>

        <div class="filters-row">
          <button class="filter-pill active" data-filter-type="all">All types</button>
          <button class="filter-pill" data-filter-type="event">Events</button>
          <button class="filter-pill" data-filter-type="lesson">Lessons</button>
          <button class="filter-pill" data-filter-type="spot">Spots</button>
          <button class="filter-pill" data-filter-type="custom">Custom</button>
          <button id="addItemBtn" class="add-btn">+ Add</button>
        </div>

        <div class="filters-row">
          <button class="filter-pill active" data-filter-privacy="all">All visibility</button>
          <button class="filter-pill" data-filter-privacy="public">Public</button>
          <button class="filter-pill" data-filter-privacy="private">Private</button>
          <button class="filter-pill" data-filter-privacy="groups">Groups</button>
        </div>

        <div class="day-list" id="dayList"></div>
        <div class="day-empty" id="dayEmpty" style="display:none;">Nothing on this day yet. Click ‚Äú+ Add‚Äù or add from events/lessons.</div>

        <div class="share-panel">
          <div>Share your calendar with another user (username or ID):</div>
          <input id="shareTargetInput" placeholder="Enter username or user ID">
          <button id="shareCalendarBtn">Share Calendar</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* AUTH CHECK (ROBUST) */
let user = null;
try {
  user = JSON.parse(localStorage.getItem("rc_user"));
} catch(e) {
  user = null;
}
if (!user || (!user.id && !user.username)) {
  window.location.href = "index.html";
}
const OWNER_ID = user.id || user.username || "anonymous";

/* BURGER */
document.getElementById("hamburger").onclick = () => {
  document.getElementById("hamburger").classList.toggle("active");
  document.getElementById("sidebar").classList.toggle("open");
};

/* STORAGE HELPERS */
function getCalendarItems() {
  try {
    return JSON.parse(localStorage.getItem("rc_calendar_items") || "[]");
  } catch(e) {
    return [];
  }
}
function saveCalendarItems(items) {
  localStorage.setItem("rc_calendar_items", JSON.stringify(items));
}

function getCalendarShares() {
  try {
    return JSON.parse(localStorage.getItem("rc_calendar_shares") || "[]");
  } catch(e) {
    return [];
  }
}
function saveCalendarShares(shares) {
  localStorage.setItem("rc_calendar_shares", JSON.stringify(shares));
}

/* SEED FROM EVENTS, SPOTS, LESSONS (LESSONS = rc_lessons) */
function seedCalendarFromSources() {
  const items = getCalendarItems();
  const existingRefs = new Set(items.map(i => (i.type || "") + "::" + (i.refId || "") + "::" + (i.ownerId || "")));

  const events = JSON.parse(localStorage.getItem("rc_events") || "[]");
  const spots = JSON.parse(localStorage.getItem("rc_spots") || "[]");
  const lessons = JSON.parse(localStorage.getItem("rc_lessons") || "[]");

  const savedEvents = JSON.parse(localStorage.getItem("rc_user_saved_events") || "[]");
  const savedSpots = JSON.parse(localStorage.getItem("rc_user_saved_spots") || "[]");
  const savedLessons = JSON.parse(localStorage.getItem("rc_user_saved_lessons") || "[]");

  // events
  events.forEach(ev => {
    if (!savedEvents.includes(ev.id)) return;
    const key = "event::" + ev.id + "::" + OWNER_ID;
    if (existingRefs.has(key)) return;
    items.push({
      id: "cal_" + Date.now() + "_" + Math.random().toString(16).slice(2),
      ownerId: OWNER_ID,
      type: "event",
      refId: ev.id,
      title: ev.title || "Untitled Event",
      date: ev.date || null,
      time: ev.time || "",
      location: ev.location || null,
      distance: null,
      link: ev.id ? `event-details.html?id=${ev.id}` : "",
      privacy: "public",
      groups: [],
      source: "event"
    });
  });

  // spots
  spots.forEach(sp => {
    if (!savedSpots.includes(sp.id)) return;
    const key = "spot::" + sp.id + "::" + OWNER_ID;
    if (existingRefs.has(key)) return;
    items.push({
      id: "cal_" + Date.now() + "_" + Math.random().toString(16).slice(2),
      ownerId: OWNER_ID,
      type: "spot",
      refId: sp.id,
      title: sp.name || "Untitled Spot",
      date: null,
      time: "",
      location: sp.location || null,
      distance: sp.distance || null,
      link: sp.id ? `spot-details.html?id=${sp.id}` : "",
      privacy: "public",
      groups: [],
      source: "spot"
    });
  });

  // lessons
  lessons.forEach(ls => {
    if (!savedLessons.includes(ls.id)) return;
    const key = "lesson::" + ls.id + "::" + OWNER_ID;
    if (existingRefs.has(key)) return;
    items.push({
      id: "cal_" + Date.now() + "_" + Math.random().toString(16).slice(2),
      ownerId: OWNER_ID,
      type: "lesson",
      refId: ls.id,
      title: ls.title || "Lesson",
      date: ls.date || null,
      time: ls.time || "",
      location: ls.location || null,
      distance: null,
      link: ls.link || "",
      privacy: "public",
      groups: [],
      source: "lesson"
    });
  });

  saveCalendarItems(items);
}

/* GLOBAL ENTRY POINTS FROM OTHER PAGES (events.html, lessons, groups, etc.) */
window.addToCalendarFromEvent = function(ev, privacy="public", groups=[]) {
  const items = getCalendarItems();
  items.push({
    id: "cal_" + Date.now() + "_" + Math.random().toString(16).slice(2),
    ownerId: OWNER_ID,
    type: "event",
    refId: ev.id || null,
    title: ev.title || "Untitled Event",
    date: ev.date || null,
    time: ev.time || "",
    location: ev.location || null,
    distance: null,
    link: ev.id ? `event-details.html?id=${ev.id}` : "",
    privacy,
    groups: groups || [],
    source:"event"
  });
  saveCalendarItems(items);
};

window.addToCalendarFromLesson = function(ls, privacy="public", groups=[]) {
  const items = getCalendarItems();
  items.push({
    id: "cal_" + Date.now() + "_" + Math.random().toString(16).slice(2),
    ownerId: OWNER_ID,
    type: "lesson",
    refId: ls.id || null,
    title: ls.title || "Lesson",
    date: ls.date || null,
    time: ls.time || "",
    location: ls.location || null,
    distance: null,
    link: ls.link || "",
    privacy,
    groups: groups || [],
    source:"lesson"
  });
  saveCalendarItems(items);
};

window.addToCalendarFromSpot = function(sp, privacy="public", groups=[]) {
  const items = getCalendarItems();
  items.push({
    id: "cal_" + Date.now() + "_" + Math.random().toString(16).slice(2),
    ownerId: OWNER_ID,
    type: "spot",
    refId: sp.id || null,
    title: sp.name || "Untitled Spot",
    date: sp.date || null,
    time: "",
    location: sp.location || null,
    distance: sp.distance || null,
    link: sp.id ? `spot-details.html?id=${sp.id}` : "",
    privacy,
    groups: groups || [],
    source:"spot"
  });
  saveCalendarItems(items);
};

/* CALENDAR STATE */
let currentYear, currentMonth; // month = 0-11
let selectedDate = null;       // "YYYY-MM-DD"
let currentTypeFilter = "all";
let currentPrivacyFilter = "all";

/* DATE HELPERS */
function toISODate(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function formatPrettyDate(iso) {
  if (!iso) return "";
  const [y,m,d] = iso.split("-");
  const date = new Date(+y, +m-1, +d);
  return date.toLocaleDateString(undefined,{weekday:"long", month:"long", day:"numeric", year:"numeric"});
}

/* RENDER MONTH GRID */
function renderMonth() {
  const monthNameEl = document.getElementById("monthName");
  const grid = document.getElementById("calendarGrid");
  grid.innerHTML = "";

  const monthDate = new Date(currentYear, currentMonth, 1);
  const monthName = monthDate.toLocaleString(undefined,{month:"long", year:"numeric"});
  monthNameEl.textContent = monthName;

  const firstDayIndex = monthDate.getDay();
  const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
  const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

  const todayISO = toISODate(new Date());
  const items = getCalendarItems().filter(i => i.ownerId === OWNER_ID);

  const cells = [];
  for (let i=0; i<firstDayIndex; i++) {
    const day = daysInPrevMonth - firstDayIndex + 1 + i;
    const d = new Date(currentYear, currentMonth-1, day);
    cells.push({date:d, other:true});
  }
  for (let d=1; d<=daysInMonth; d++) {
    cells.push({date:new Date(currentYear, currentMonth, d), other:false});
  }
  while (cells.length % 7 !== 0) {
    const day = cells.length - firstDayIndex - daysInMonth + 1;
    const d = new Date(currentYear, currentMonth+1, day);
    cells.push({date:d, other:true});
  }

  cells.forEach(cell => {
    const iso = toISODate(cell.date);
    const cellItems = items.filter(i => i.date === iso);
    const cellDiv = document.createElement("div");
    cellDiv.className = "day-cell" + (cell.other ? " other-month" : "");
    if (iso === todayISO) cellDiv.classList.add("today");
    if (iso === selectedDate) cellDiv.classList.add("selected");
    cellDiv.dataset.date = iso;

    const numDiv = document.createElement("div");
    numDiv.className = "day-number";
    numDiv.textContent = cell.date.getDate();
    cellDiv.appendChild(numDiv);

    // small tags to show presence of items + visibility
    if (cellItems.length) {
      const tagsDiv = document.createElement("div");
      tagsDiv.className = "day-tags";

      const hasEvent = cellItems.some(i => i.type === "event");
      const hasLesson = cellItems.some(i => i.type === "lesson");
      const hasSpot = cellItems.some(i => i.type === "spot");
      const hasCustom = cellItems.some(i => i.type === "custom");

      if (hasEvent) {
        const t = document.createElement("span");
        t.className = "day-tag-pill public";
        t.textContent = "Event";
        tagsDiv.appendChild(t);
      }
      if (hasLesson) {
        const t = document.createElement("span");
        t.className = "day-tag-pill public";
        t.textContent = "Lesson";
        tagsDiv.appendChild(t);
      }
      if (hasSpot) {
        const t = document.createElement("span");
        t.className = "day-tag-pill public";
        t.textContent = "Spot";
        tagsDiv.appendChild(t);
      }
      if (hasCustom) {
        const t = document.createElement("span");
        t.className = "day-tag-pill private";
        t.textContent = "Custom";
        tagsDiv.appendChild(t);
      }

      cellDiv.appendChild(tagsDiv);
    }

    // click or double-click to focus this day
    cellDiv.onclick = () => {
      selectedDate = iso;
      renderMonth();
      renderSelectedDay();
    };

    grid.appendChild(cellDiv);
  });
}

/* RENDER SELECTED DAY LIST */
function renderSelectedDay() {
  const labelEl = document.getElementById("selectedDateLabel");
  const listEl = document.getElementById("dayList");
  const emptyEl = document.getElementById("dayEmpty");

  if (!selectedDate) {
    const today = toISODate(new Date());
    selectedDate = today;
  }

  labelEl.textContent = formatPrettyDate(selectedDate);
  listEl.innerHTML = "";

  const allItems = getCalendarItems().filter(i => i.ownerId === OWNER_ID && i.date === selectedDate);

  const visibleItems = allItems.filter(item => {
    if (currentTypeFilter !== "all" && item.type !== currentTypeFilter) return false;
    if (currentPrivacyFilter !== "all" && item.privacy !== currentPrivacyFilter) return false;
    return true;
  });

  if (!visibleItems.length) {
    emptyEl.style.display = "block";
    return;
  }
  emptyEl.style.display = "none";

  visibleItems.forEach(item => {
    const li = document.createElement("div");
    li.className = "calendar-item";
    li.dataset.id = item.id;

    const typeLabel =
      item.type === "event" ? "üìÖ Event" :
      item.type === "lesson" ? "üéì Lesson" :
      item.type === "spot" ? "üìç Spot" :
      "‚≠ê Custom";

    const privacyLabel =
      item.privacy === "public" ? "üåê Public" :
      item.privacy === "private" ? "üîí Private" :
      "üë• Groups";

    const groupsText =
      item.privacy === "groups" && item.groups && item.groups.length
        ? `<br>Groups: ${item.groups.join(", ")}`
        : "";

    li.innerHTML = `
      <div class="calendar-item-header">
        <div>
          <strong>${item.title}</strong>
          <div class="calendar-item-type">${typeLabel}</div>
        </div>
        <div class="calendar-item-privacy">${privacyLabel}</div>
      </div>
      <div>
        ${item.time ? `‚è∞ ${item.time}<br>` : ""}
        ${item.location ? `üìç ${item.location}<br>` : ""}
        ${item.distance ? `üõº ${item.distance} miles away<br>` : ""}
        ${item.link ? `<a href="${item.link}">View details</a><br>` : ""}
        ${groupsText}
      </div>
      <div class="item-actions">
        <button class="edit-btn">Edit</button>
        <button class="delete-btn">Delete</button>
      </div>
    `;

    listEl.appendChild(li);
  });
}

/* INLINE EDITOR */
function openEditorFor(id) {
  const items = getCalendarItems();
  const item = items.find(i => i.id === id && i.ownerId === OWNER_ID);
  if (!item) return;

  const listEl = document.getElementById("dayList");
  const card = listEl.querySelector(`.calendar-item[data-id="${id}"]`);
  if (!card) return;

  let existing = card.querySelector(".editor");
  if (existing) existing.remove();

  const ed = document.createElement("div");
  ed.className = "editor";
  const groupStr = (item.groups || []).join(", ");

  ed.innerHTML = `
    <div class="editor-row">
      <input data-field="title" placeholder="Title" value="${item.title || ""}">
      <input data-field="time" placeholder="Time (e.g. 7:00 PM)" value="${item.time || ""}">
      <input data-field="location" placeholder="Location" value="${item.location || ""}">
      <input data-field="distance" placeholder="Distance (miles)" value="${item.distance || ""}">
    </div>
    <div class="editor-row" style="margin-top:4px;">
      <select data-field="privacy">
        <option value="public" ${item.privacy === "public" ? "selected" : ""}>Public</option>
        <option value="private" ${item.privacy === "private" ? "selected" : ""}>Private</option>
        <option value="groups" ${item.privacy === "groups" ? "selected" : ""}>Groups</option>
      </select>
      <input data-field="groups" placeholder="Groups (comma separated)" value="${groupStr}">
    </div>
    <div class="editor-actions">
      <button class="save-btn">Save</button>
      <button class="cancel-btn">Cancel</button>
    </div>
  `;

  card.appendChild(ed);

  ed.querySelector(".save-btn").onclick = () => {
    ed.querySelectorAll("[data-field]").forEach(el => {
      const field = el.dataset.field;
      const value = el.value.trim();
      if (field === "groups") {
        item.groups = value ? value.split(",").map(v => v.trim()).filter(Boolean) : [];
      } else if (field === "distance") {
        item.distance = value || null;
      } else {
        item[field] = value || null;
      }
    });
    saveCalendarItems(items);
    renderSelectedDay();
    renderMonth();
  };
  ed.querySelector(".cancel-btn").onclick = () => ed.remove();
}

/* DELETE ITEM */
function deleteItem(id) {
  let items = getCalendarItems();
  items = items.filter(i => !(i.id === id && i.ownerId === OWNER_ID));
  saveCalendarItems(items);
  renderSelectedDay();
  renderMonth();
}

/* ADD CUSTOM ITEM */
function addCustomForSelectedDay() {
  if (!selectedDate) selectedDate = toISODate(new Date());
  const items = getCalendarItems();
  const id = "cal_" + Date.now() + "_" + Math.random().toString(16).slice(2);
  items.push({
    id,
    ownerId: OWNER_ID,
    type: "custom",
    refId: null,
    title: "New custom item",
    date: selectedDate,
    time: "",
    location: "",
    distance: null,
    link: "",
    privacy: "private",
    groups: [],
    source:"custom"
  });
  saveCalendarItems(items);
  renderSelectedDay();
  renderMonth();
  openEditorFor(id);
}

/* LIST CLICK HANDLERS */
document.getElementById("dayList").addEventListener("click", e => {
  const card = e.target.closest(".calendar-item");
  if (!card) return;
  const id = card.dataset.id;
  if (e.target.classList.contains("edit-btn")) {
    openEditorFor(id);
  } else if (e.target.classList.contains("delete-btn")) {
    deleteItem(id);
  }
});

/* FILTER HANDLERS */
document.querySelectorAll("[data-filter-type]").forEach(btn => {
  btn.addEventListener("click", () => {
    currentTypeFilter = btn.dataset.filterType;
    document.querySelectorAll("[data-filter-type]").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    renderSelectedDay();
  });
});
document.querySelectorAll("[data-filter-privacy]").forEach(btn => {
  btn.addEventListener("click", () => {
    currentPrivacyFilter = btn.dataset.filterPrivacy;
    document.querySelectorAll("[data-filter-privacy]").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    renderSelectedDay();
  });
});

document.getElementById("addItemBtn").onclick = addCustomForSelectedDay;

/* MONTH NAV */
document.getElementById("prevMonthBtn").onclick = () => {
  currentMonth--;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  }
  renderMonth();
  renderSelectedDay();
};
document.getElementById("nextMonthBtn").onclick = () => {
  currentMonth++;
  if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  renderMonth();
  renderSelectedDay();
};

/* SHARE CALENDAR (OWNER -> TARGET) */
document.getElementById("shareCalendarBtn").onclick = () => {
  const input = document.getElementById("shareTargetInput");
  const target = input.value.trim();
  if (!target) return;
  const shares = getCalendarShares();
  shares.push({
    ownerId: OWNER_ID,
    targetId: target,
    mode: "view" // could extend later: "edit"
  });
  saveCalendarShares(shares);
  input.value = "";
  alert("Your calendar is now shared with: " + target);
};

/* FLOATING BUBBLES ANIMATION (PONG STYLE) */
const bubbles = [
  {el:document.getElementById("bubbleChat"), x:60,  y:120, vx:1.4, vy:1.1},
  {el:document.getElementById("bubbleProfile"), x:window.innerWidth-240, y:80, vx:-1.2, vy:1.5},
  {el:document.getElementById("bubbleSpots"), x:80, y:window.innerHeight-240, vx:1.6, vy:-1.3},
  {el:document.getElementById("bubbleDashboard"), x:window.innerWidth-240, y:window.innerHeight-240, vx:-1.5, vy:-1.4}
];

function positionBubblesInitial() {
  bubbles.forEach(b => {
    b.el.style.left = b.x + "px";
    b.el.style.top = b.y + "px";
  });
}

function animateBubbles() {
  const w = window.innerWidth;
  const h = window.innerHeight;
  const size = 160;

  bubbles.forEach(b => {
    b.x += b.vx;
    b.y += b.vy;

    if (b.x <= 0 || b.x + size >= w) b.vx *= -1;
    if (b.y <= 0 || b.y + size >= h) b.vy *= -1;

    // simple separation
    bubbles.forEach(o => {
      if (o === b) return;
      const dx = (b.x+size/2) - (o.x+size/2);
      const dy = (b.y+size/2) - (o.y+size/2);
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < size) {
        b.vx *= -1;
        b.vy *= -1;
      }
    });

    b.el.style.left = b.x + "px";
    b.el.style.top = b.y + "px";
  });

  requestAnimationFrame(animateBubbles);
}

/* INIT */
(function init() {
  const now = new Date();
  currentYear = now.getFullYear();
  currentMonth = now.getMonth();
  selectedDate = toISODate(now);

  seedCalendarFromSources();
  renderMonth();
  renderSelectedDay();
  positionBubblesInitial();
  animateBubbles();
})();
</script>

</body>
</html>
