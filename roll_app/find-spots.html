<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Find Spots – Roll ’n Connect</title>

  <!-- GLOBAL STYLES -->
  <link rel="stylesheet" href="styles/style.css">

  <!-- GOOGLE MAPS (REPLACE API_KEY LOCALLY) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=<!DOCTYPE html>
<html>
  <head>
    <title>Maps and Places Autocomplete</title>
    <script>
      async function init() {
        await customElements.whenDefined('gmp-map');

        const map = document.querySelector('gmp-map');
        const marker = document.querySelector('gmp-advanced-marker');
        const placePicker = document.querySelector('gmpx-place-picker');
        const infowindow = new google.maps.InfoWindow();

        map.innerMap.setOptions({
          mapTypeControl: false
        });

        placePicker.addEventListener('gmpx-placechange', () => {
          const place = placePicker.value;

          if (!place.location) {
            window.alert(
              "No details available for input: '" + place.name + "'"
            );
            infowindow.close();
            marker.position = null;
            return;
          }

          if (place.viewport) {
            map.innerMap.fitBounds(place.viewport);
          } else {
            map.center = place.location;
            map.zoom = 17;
          }

          marker.position = place.location;
          infowindow.setContent(
            `<strong>${place.displayName}</strong><br>
             <span>${place.formattedAddress}</span>
          `);
          infowindow.open(map.innerMap, marker);
        });
      }

      document.addEventListener('DOMContentLoaded', init);
    </script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/@googlemaps/extended-component-library/0.6.11/index.min.js">
    </script>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      .place-picker-container {
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <gmpx-api-loader key="AIzaSyB02c_eleXuhHWdSMJzqk9mESbXn_PT2zc" solution-channel="GMP_GE_mapsandplacesautocomplete_v2">
    </gmpx-api-loader>
    <gmp-map center="40.749933,-73.98633" zoom="13" map-id="DEMO_MAP_ID">
      <div slot="control-block-start-inline-start" class="place-picker-container">
        <gmpx-place-picker placeholder="Enter an address"></gmpx-place-picker>
      </div>
      <gmp-advanced-marker></gmp-advanced-marker>
    </gmp-map>
  </body>
</html>&libraries=places"></script>

  <style>
    body {
      margin:0;
      font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#02040a;
      color:#fff;
    }

    .page {
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header {
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:radial-gradient(circle at top,#1d2340,#050712 55%,#02040a);
      position:sticky;
      top:0;
      z-index:10;
    }

    .app-title {
      font-weight:600;
      font-size:1rem;
    }

    nav a {
      color:#fff;
      text-decoration:none;
      font-size:0.85rem;
      margin-left:10px;
      opacity:0.85;
    }
    nav a:hover { opacity:1; }

    .map-wrap {
      position:relative;
      height:320px;
      width:100%;
    }

    #map {
      width:100%;
      height:100%;
    }

    .filters-bar {
      padding:10px 12px;
      display:flex;
      gap:8px;
      overflow-x:auto;
      background:#050815;
      border-bottom:1px solid rgba(255,255,255,0.08);
    }

    .filter-btn {
      padding:6px 10px;
      font-size:0.8rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.2);
      background:rgba(255,255,255,0.05);
      color:#fff;
      cursor:pointer;
      white-space:nowrap;
    }
    .filter-btn.active {
      background:#fff;
      color:#000;
      border-color:#fff;
    }

    .content {
      padding:12px 16px 40px;
    }

    .search-row {
      display:flex;
      gap:8px;
      margin-bottom:10px;
    }
    .search-row input {
      flex:1;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.4);
      color:#fff;
      font-size:0.85rem;
    }
    .search-row button {
      padding:8px 12px;
      border-radius:999px;
      border:none;
      font-size:0.8rem;
      font-weight:600;
      cursor:pointer;
      background:#fff;
      color:#000;
    }

    .spot-list {
      margin-top:8px;
    }
    .spot-card {
      border-radius:10px;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.08);
      padding:10px;
      margin-bottom:8px;
      cursor:pointer;
      font-size:0.85rem;
    }
    .spot-card:hover {
      background:rgba(255,255,255,0.07);
    }
    .spot-card-title {
      font-weight:600;
      margin-bottom:2px;
    }
    .spot-card-meta {
      font-size:0.78rem;
      opacity:0.8;
    }

    .section-title {
      font-size:0.95rem;
      font-weight:600;
      margin:14px 0 6px;
    }

    .rating-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:0.8rem;
      margin-bottom:3px;
    }
    .rating-value {
      font-weight:600;
    }

    .review-form input,
    .review-form textarea,
    .review-form select {
      width:100%;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.5);
      color:#fff;
      padding:6px 8px;
      font-size:0.8rem;
      margin-bottom:6px;
    }
    .review-grid {
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px 10px;
      font-size:0.78rem;
    }
    .review-grid label {
      display:block;
    }

    .review-list {
      margin-top:4px;
    }
    .review-item {
      border-radius:8px;
      background:rgba(255,255,255,0.04);
      padding:6px 8px;
      margin-bottom:4px;
      font-size:0.8rem;
    }
    .review-meta {
      font-weight:600;
      font-size:0.76rem;
      margin-bottom:2px;
      opacity:0.9;
    }
    .review-ratings {
      font-size:0.74rem;
      opacity:0.8;
      margin-top:2px;
    }

    .primary-btn {
      width:100%;
      margin-top:4px;
      padding:8px;
      border-radius:999px;
      border:none;
      background:#fff;
      color:#000;
      font-size:0.85rem;
      font-weight:600;
      cursor:pointer;
    }

    .link-row {
      margin-top:10px;
      font-size:0.8rem;
      opacity:0.85;
    }
    .link-row a {
      color:#8bd5ff;
      text-decoration:none;
    }
    .link-row a:hover {
      text-decoration:underline;
    }
  </style>
</head>

<body>
<div class="page">
  <header>
    <div class="app-title">Find Spots</div>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="events.html">Events</a>
      <a href="calendar.html">Calendar</a>
    </nav>
  </header>

  <div class="map-wrap">
    <div id="map"></div>
  </div>

  <div class="filters-bar">
    <button class="filter-btn active" data-type="">All</button>
    <button class="filter-btn" data-type="skatepark">Skateparks</button>
    <button class="filter-btn" data-type="rink">Rinks</button>
    <button class="filter-btn" data-type="water">Water</button>
    <button class="filter-btn" data-type="food">Food</button>
    <button class="filter-btn" data-type="parking">Parking Lots</button>
    <button class="filter-btn" data-type="restroom">Restrooms</button>
  </div>

  <main class="content">
    <div class="search-row">
      <input id="searchInput" placeholder="Search a place or address">
      <button id="searchBtn">Search</button>
    </div>

    <div class="spot-list" id="spotList"></div>

    <section id="spotDetailsSection" style="display:none;">
      <h2 class="section-title" id="spotTitle"></h2>
      <div id="spotAddress" style="font-size:0.85rem;opacity:0.9;margin-bottom:4px;"></div>
      <div id="spotGoogleRating" style="font-size:0.8rem;opacity:0.85;margin-bottom:8px;"></div>

      <div class="section-title">Community ratings</div>
      <div class="rating-row"><span>Smoothness</span><span id="avgSmooth" class="rating-value">–</span></div>
      <div class="rating-row"><span>Difficulty</span><span id="avgDifficulty" class="rating-value">–</span></div>

      <button id="addToCalendarBtn" class="primary-btn">Add this spot to my calendar</button>

      <div class="section-title">Leave a review</div>
      <div class="review-form">
        <input id="reviewName" placeholder="Your name or handle">
        <textarea id="reviewText" rows="2" placeholder="Share how it felt to skate here"></textarea>

        <div class="review-grid">
          <label>Smoothness
            <select id="rateSmooth">
              <option value="">–</option>
              <option value="1">⭐ 1 (rough)</option>
              <option value="2">⭐ 2</option>
              <option value="3">⭐ 3</option>
              <option value="4">⭐ 4</option>
              <option value="5">⭐ 5 (glass)</option>
            </select>
          </label>
          <label>Difficulty
            <select id="rateDifficulty">
              <option value="">–</option>
              <option value="1">1 – very easy</option>
              <option value="2">2 – easy</option>
              <option value="3">3 – medium</option>
              <option value="4">4 – hard</option>
              <option value="5">5 – expert</option>
            </select>
          </label>
        </div>

        <button id="submitReview" class="primary-btn">Post review</button>
      </div>

      <div class="section-title">Reviews</div>
      <div id="reviewList" class="review-list"></div>

      <div class="link-row">
        Events using this spot will appear in your <a href="events.html">Events</a> and <a href="calendar.html">Calendar</a> pages through shared storage.
      </div>
    </section>
  </main>
</div>

<script>
let map;
let placesService;
let markers=[];
let spots=[];
let activeSpot=null;

const spotListEl=document.getElementById("spotList");
const spotDetailsSection=document.getElementById("spotDetailsSection");
const spotTitleEl=document.getElementById("spotTitle");
const spotAddressEl=document.getElementById("spotAddress");
const spotGoogleRatingEl=document.getElementById("spotGoogleRating");
const avgSmoothEl=document.getElementById("avgSmooth");
const avgDifficultyEl=document.getElementById("avgDifficulty");
const reviewListEl=document.getElementById("reviewList");

const reviewNameEl=document.getElementById("reviewName");
const reviewTextEl=document.getElementById("reviewText");
const rateSmoothEl=document.getElementById("rateSmooth");
const rateDifficultyEl=document.getElementById("rateDifficulty");

function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{
    center:{lat:33.8,lng:-84.3},
    zoom:11,
    disableDefaultUI:false
  });
  placesService=new google.maps.places.PlacesService(map);
}
window.onload=initMap;

function clearMarkers(){
  markers.forEach(m=>m.setMap(null));
  markers=[];
}

function renderSpotList(){
  spotListEl.innerHTML="";
  spots.forEach((spot,index)=>{
    const div=document.createElement("div");
    div.className="spot-card";
    div.dataset.index=index;

    const title=document.createElement("div");
    title.className="spot-card-title";
    title.textContent=spot.name;

    const meta=document.createElement("div");
    meta.className="spot-card-meta";
    const ratingText=spot.rating?`⭐ ${spot.rating.toFixed(1)} (${spot.user_ratings_total||0}) • `:"";
    meta.textContent=`${ratingText}${spot.formatted_address||""}`;

    div.appendChild(title);
    div.appendChild(meta);

    div.onclick=()=>focusSpot(index);

    spotListEl.appendChild(div);
  });
}

function loadReviews(placeId){
  return JSON.parse(localStorage.getItem("rc_reviews_simple_"+placeId)||"[]");
}
function saveReviews(placeId,reviews){
  localStorage.setItem("rc_reviews_simple_"+placeId,JSON.stringify(reviews));
}
function computeAverage(reviews,key){
  const vals=reviews.map(r=>Number(r[key])).filter(v=>!isNaN(v));
  if(!vals.length) return null;
  return (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1);
}

function renderReviews(placeId){
  const reviews=loadReviews(placeId);
  reviewListEl.innerHTML="";
  if(!reviews.length){
    reviewListEl.innerHTML='<div style="opacity:0.75;font-size:0.8rem;">No reviews yet. Be the first to log a session.</div>';
    avgSmoothEl.textContent="–";
    avgDifficultyEl.textContent="–";
    return;
  }

  const avgSmooth=computeAverage(reviews,"smoothness");
  const avgDiff=computeAverage(reviews,"difficulty");
  avgSmoothEl.textContent=avgSmooth?`${avgSmooth}/5`:"–";
  avgDifficultyEl.textContent=avgDiff?`${avgDiff}/5`:"–";

  reviews.forEach(r=>{
    const div=document.createElement("div");
    div.className="review-item";
    const ratingsLine=[
      r.smoothness?`Smoothness: ${r.smoothness}/5`:"",
      r.difficulty?`Difficulty: ${r.difficulty}/5`:""
    ].filter(Boolean).join(" • ");

    div.innerHTML=`
      <div class="review-meta">${r.name||"Anonymous"} · ${new Date(r.time).toLocaleDateString()}</div>
      <div>${r.text}</div>
      ${ratingsLine?`<div class="review-ratings">${ratingsLine}</div>`:""}
    `;
    reviewListEl.appendChild(div);
  });
}

function focusSpot(index){
  const spot=spots[index];
  if(!spot) return;
  activeSpot=spot;

  const loc=spot.geometry.location;
  map.panTo(loc);
  map.setZoom(15);

  spotTitleEl.textContent=spot.name;
  spotAddressEl.textContent=spot.formatted_address||"";
  if(spot.rating){
    spotGoogleRatingEl.textContent=`Google: ⭐ ${spot.rating.toFixed(1)} (${spot.user_ratings_total||0} ratings)`;
  }else{
    spotGoogleRatingEl.textContent="No Google rating data";
  }

  reviewNameEl.value="";
  reviewTextEl.value="";
  rateSmoothEl.value="";
  rateDifficultyEl.value="";

  renderReviews(spot.place_id);
  spotDetailsSection.style.display="block";
}

function runSearch(query){
  if(!query||!placesService) return;

  const request={
    query:query,
    location:map.getCenter(),
    radius:20000
  };

  placesService.textSearch(request,(results,status)=>{
    if(status!==google.maps.places.PlacesServiceStatus.OK||!results||!results.length) return;
    spots=results;
    clearMarkers();

    results.forEach((spot,index)=>{
      const marker=new google.maps.Marker({
        map,
        position:spot.geometry.location,
        title:spot.name
      });
      marker.addListener("click",()=>focusSpot(index));
      markers.push(marker);
    });

    renderSpotList();
    focusSpot(0);
  });
}

document.getElementById("searchBtn").onclick=()=>{
  const v=document.getElementById("searchInput").value.trim();
  runSearch(v);
};
document.getElementById("searchInput").addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    runSearch(e.target.value.trim());
  }
});

document.querySelectorAll(".filter-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const type=btn.dataset.type;
    let query="skate spot";

    if(type==="skatepark") query="skatepark";
    else if(type==="rink") query="roller rink OR ice rink";
    else if(type==="water") query="water fountain OR hydration station";
    else if(type==="food") query="food near skating";
    else if(type==="parking") query="parking lot";
    else if(type==="restroom") query="public restroom near park";

    runSearch(query);
  });
});

document.getElementById("submitReview").onclick=()=>{
  if(!activeSpot) return;
  const name=(reviewNameEl.value||"Anonymous").trim();
  const text=(reviewTextEl.value||"").trim();
  if(!text) return;

  const review={
    name,
    text,
    time:Date.now(),
    smoothness:rateSmoothEl.value?Number(rateSmoothEl.value):null,
    difficulty:rateDifficultyEl.value?Number(rateDifficultyEl.value):null
  };

  const reviews=loadReviews(activeSpot.place_id);
  reviews.push(review);
  saveReviews(activeSpot.place_id,reviews);
  renderReviews(activeSpot.place_id);

  reviewTextEl.value="";
  rateSmoothEl.value="";
  rateDifficultyEl.value="";
};

document.getElementById("addToCalendarBtn").onclick=()=>{
  if(!activeSpot) return;
  const events=JSON.parse(localStorage.getItem("rc_calendar")||"[]");

  events.push({
    title:activeSpot.name,
    location:activeSpot.formatted_address||"",
    lat:activeSpot.geometry.location.lat(),
    lng:activeSpot.geometry.location.lng(),
    createdAt:Date.now(),
    type:"spot-session"
  });

  localStorage.setItem("rc_calendar",JSON.stringify(events));

  const allEvents=JSON.parse(localStorage.getItem("rc_events")||"[]");
  allEvents.push({
    title:"Session at "+activeSpot.name,
    location:activeSpot.formatted_address||"",
    lat:activeSpot.geometry.location.lat(),
    lng:activeSpot.geometry.location.lng(),
    createdAt:Date.now(),
    source:"find-spots"
  });
  localStorage.setItem("rc_events",JSON.stringify(allEvents));
};
</script>
</body>
</html>
