<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Find Spots ‚Äì Roll ‚Äôn Connect</title>
  <link rel="stylesheet" href="styles/style.css">

  <!-- GOOGLE MAPS -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB02c_eleXuhHWdSMJzqk9mESbXn_PT2zc&libraries=places,marker"></script>

  <style>
    body {
      background:#000;
      color:#fff;
      margin:0;
      padding:0;
      font-family:'Inter',sans-serif;
      overflow:hidden;
    }

    /* STARFIELDS */
    .stars1,.stars2,.stars3 {
      position:fixed; inset:0;
      background:url('styles/stars-white.png') repeat;
      z-index:-3;
      pointer-events:none;
    }
    .stars1{opacity:.55;animation:drift1 140s linear infinite;}
    .stars2{opacity:.35;animation:drift2 200s linear infinite;}
    .stars3{opacity:.2; animation:drift3 260s linear infinite;}

    @keyframes drift1{from{background-position:0 0;}to{background-position:0 -5000px;}}
    @keyframes drift2{from{background-position:0 0;}to{background-position:-4000px -2000px;}}
    @keyframes drift3{from{background-position:0 0;}to{background-position:3000px 4000px;}}

    /* FLOATING SIDEBAR */
    .sidebar {
      position:fixed;
      top:50%;
      left:-260px;
      transform:translateY(-50%);
      width:260px;
      background:rgba(255,255,255,0.08);
      backdrop-filter:blur(25px);
      border-right:1px solid rgba(255,255,255,0.25);
      padding:30px 20px;
      border-radius:0 20px 20px 0;
      box-shadow:10px 0 40px rgba(255,255,255,0.25);
      transition:0.35s ease;
      z-index:9998;
    }
    .sidebar.open { left:0; }

    /* BURGER */
    .hamburger {
      position:fixed;
      top:25px;
      left:25px;
      width:40px;
      height:30px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      cursor:pointer;
      z-index:9999;
    }
    .hamburger span {
      height:4px;
      width:100%;
      background:#fff;
      border-radius:4px;
      box-shadow:0 0 12px rgba(255,255,255,0.9);
      transition:0.3s;
    }
    .hamburger.active span:nth-child(1){transform:translateY(13px) rotate(45deg);}
    .hamburger.active span:nth-child(2){opacity:0;}
    .hamburger.active span:nth-child(3){transform:translateY(-13px) rotate(-45deg);}

    /* NAV LINKS */
    .nav-header{text-align:center;margin-bottom:30px;}
    .logo-orb{font-size:3rem;margin-bottom:10px;text-shadow:0 0 20px #fff;}
    .nav-title{font-size:1.4rem;font-weight:600;text-shadow:0 0 10px #fff;}

    .nav-links {
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .nav-links a {
      color:#fff;
      text-decoration:none;
      font-size:1.05rem;
      padding:10px 14px;
      border-radius:12px;
      transition:0.25s;
      display:block;
      background:rgba(255,255,255,0.05);
      box-shadow:0 0 12px rgba(255,255,255,0.15);
    }
    .nav-links a:hover {
      background:rgba(255,255,255,0.2);
      transform:translateX(8px);
      box-shadow:0 0 20px rgba(255,255,255,0.4);
    }

    /* MAP */
    #map {
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100vh;
      z-index:1;
    }

    /* SEARCH PANEL */
    .search-panel {
      position:fixed;
      top:25px;
      right:25px;
      background:rgba(0,0,0,0.65);
      backdrop-filter:blur(20px);
      padding:20px;
      border-radius:20px;
      box-shadow:0 0 30px rgba(255,255,255,0.3);
      z-index:9999;
      width:300px;
    }

    .search-panel input {
      width:100%;
      padding:10px 14px;
      border-radius:12px;
      border:none;
      background:rgba(255,255,255,0.15);
      color:#fff;
      margin-bottom:12px;
    }

    .category-buttons {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:4px;
    }

    .cat-btn {
      padding:8px 14px;
      background:rgba(255,255,255,0.15);
      border-radius:12px;
      cursor:pointer;
      font-size:0.9rem;
      transition:0.25s;
    }
    .cat-btn:hover {
      background:#fff;
      color:#000;
      transform:scale(1.1);
    }

    .loc-btn {
      margin-top:12px;
      width:100%;
      padding:10px;
      background:#fff;
      color:#000;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      transition:0.25s;
      border:none;
    }
    .loc-btn:hover {
      transform:scale(1.05);
      box-shadow:0 0 20px rgba(255,255,255,0.8);
    }

    .status-text {
      margin-top:10px;
      font-size:0.8rem;
      opacity:0.85;
    }

    /* CURRENT SPOT CARD */
    .current-spot {
      margin-top:14px;
      padding:10px;
      border-radius:12px;
      background:rgba(255,255,255,0.08);
      font-size:0.85rem;
    }
    .current-spot-title {
      font-weight:600;
      margin-bottom:4px;
    }
    .current-spot-actions {
      margin-top:8px;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .btn-small {
      padding:6px 10px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:0.8rem;
    }
    .btn-primary {
      background:#fff;
      color:#000;
    }
    .btn-ghost {
      background:rgba(255,255,255,0.15);
      color:#fff;
    }

    /* FLOATING BUBBLES */
    .bubble {
      position:fixed;
      width:150px;
      height:150px;
      border-radius:50%;
      background:rgba(255,255,255,0.12);
      backdrop-filter:blur(16px);
      box-shadow:0 0 40px rgba(255,255,255,0.4);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      text-decoration:none;
      font-size:0.9rem;
      text-align:center;
      padding:10px;
      z-index:5;
      transition:transform 0.2s;
    }
    .bubble:hover { transform:scale(1.08); }

    /* MODAL */
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10000;
    }
    .modal {
      background:rgba(0,0,0,0.9);
      border-radius:18px;
      padding:20px;
      max-width:360px;
      width:90%;
      box-shadow:0 0 30px rgba(255,255,255,0.4);
    }
    .modal h2 {
      margin-top:0;
      margin-bottom:10px;
      font-size:1.3rem;
    }
    .modal label {
      display:block;
      font-size:0.85rem;
      margin:8px 0 4px;
    }
    .modal input,
    .modal textarea,
    .modal select {
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:none;
      background:rgba(255,255,255,0.15);
      color:#fff;
      font-size:0.85rem;
    }
    .modal textarea {
      resize:vertical;
      min-height:60px;
    }
    .modal-actions {
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .modal-actions button {
      padding:7px 12px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:0.85rem;
    }
    .modal-save { background:#fff; color:#000; }
    .modal-cancel { background:rgba(255,255,255,0.2); color:#fff; }

  </style>
</head>

<body>

<div class="stars1"></div>
<div class="stars2"></div>
<div class="stars3"></div>

<!-- BURGER -->
<div id="hamburger" class="hamburger"><span></span><span></span><span></span></div>

<!-- SIDEBAR -->
<nav id="sidebar" class="sidebar">
  <div class="nav-header">
    <div class="logo-orb">üìç</div>
    <div class="nav-title">Find Spots</div>
  </div>

  <ul class="nav-links">
    <li><a href="dashboard.html">üìä Dashboard</a></li>
    <li><a href="chatrooms.html">üí¨ Chatrooms</a></li>
    <li><a href="events.html">üìÖ Events</a></li>
    <li><a href="calendar.html">üóìÔ∏è Calendar</a></li>
    <li><a href="profile.html">üë§ Your Profile</a></li>
    <li><a href="profile-edit.html">‚úèÔ∏è Edit Profile</a></li>
    <li><a href="settings.html">‚öôÔ∏è Settings</a></li>
  </ul>
</nav>

<!-- FLOATING BUBBLES -->
<a href="chatrooms.html" class="bubble" id="bubbleChat">Chatrooms</a>
<a href="calendar.html" class="bubble" id="bubbleCalendar">Calendar</a>
<a href="dashboard.html" class="bubble" id="bubbleDashboard">Dashboard</a>
<a href="profile.html" class="bubble" id="bubbleProfile">Profile</a>

<!-- SEARCH PANEL -->
<div class="search-panel">
  <input id="searchInput" placeholder="Search: skatepark, rink, trail...">

  <div class="category-buttons">
    <div class="cat-btn" data-q="skatepark near me">Skateparks</div>
    <div class="cat-btn" data-q="roller rink near me">Rinks</div>
    <div class="cat-btn" data-q="trail near me">Trails</div>
    <div class="cat-btn" data-q="parking lot smooth near me">Parking Lots</div>
    <div class="cat-btn" data-q="plaza near me">Plazas</div>
  </div>

  <button class="loc-btn" id="locateMe">Use My Location</button>

  <div class="status-text" id="statusText">
    Online: search and map powered by Google. Offline: you can still create events from custom clicks.
  </div>

  <!-- CURRENT SPOT CARD -->
  <div class="current-spot" id="currentSpotCard" style="display:none;">
    <div class="current-spot-title" id="currentSpotName"></div>
    <div id="currentSpotAddress"></div>
    <div class="current-spot-actions">
      <button class="btn-small btn-primary" id="btnSaveToCalendar">Save to Calendar</button>
      <button class="btn-small btn-ghost" id="btnShareToChat">Share to Chat</button>
    </div>
  </div>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- EVENT MODAL -->
<div class="modal-backdrop" id="eventModalBackdrop">
  <div class="modal" id="eventModal">
    <h2>Create Calendar Event</h2>
    <p style="font-size:0.85rem;opacity:0.9;" id="eventSpotSummary"></p>

    <label for="eventTitle">Title / Reason</label>
    <input id="eventTitle" placeholder="Night session, practice run, meetup...">

    <label for="eventDate">Date</label>
    <input id="eventDate" type="date">

    <label for="eventTime">Time</label>
    <input id="eventTime" type="time">

    <label for="eventNotes">Notes</label>
    <textarea id="eventNotes" placeholder="What are you planning to do here?"></textarea>

    <label for="eventPrivacy">Privacy</label>
    <select id="eventPrivacy">
      <option value="public">Public</option>
      <option value="private">Private</option>
      <option value="groups">Groups</option>
    </select>

    <label for="eventGroups">Groups (comma separated, if using groups)</label>
    <input id="eventGroups" placeholder="Crew, Squad, Meetup name...">

    <div class="modal-actions">
      <button class="modal-cancel" id="cancelEventBtn">Cancel</button>
      <button class="modal-save" id="saveEventBtn">Save Event</button>
    </div>
  </div>
</div>

<!-- MAP + LOGIC -->
<script>
/* SIDEBAR */
const h = document.getElementById("hamburger");
const s = document.getElementById("sidebar");
h.onclick = () => {
  h.classList.toggle("active");
  s.classList.toggle("open");
};

/* FLOATING BUBBLES PONG */
const bubbleSize = 150;
const bubbles = [
  { el: document.getElementById("bubbleChat"), x:60, y:120, vx:1.4, vy:1.1 },
  { el: document.getElementById("bubbleCalendar"), x:window.innerWidth-220, y:80, vx:-1.3, vy:1.4 },
  { el: document.getElementById("bubbleDashboard"), x:80, y:window.innerHeight-230, vx:1.6, vy:-1.2 },
  { el: document.getElementById("bubbleProfile"), x:window.innerWidth-220, y:window.innerHeight-230, vx:-1.5, vy:-1.3 }
];
function positionBubbles() {
  bubbles.forEach(b => {
    b.el.style.left = b.x + "px";
    b.el.style.top = b.y + "px";
  });
}
function animateBubbles() {
  const w = window.innerWidth;
  const h = window.innerHeight;
  bubbles.forEach(b => {
    b.x += b.vx;
    b.y += b.vy;
    if (b.x <= 0 || b.x + bubbleSize >= w) b.vx *= -1;
    if (b.y <= 0 || b.y + bubbleSize >= h) b.vy *= -1;
    bubbles.forEach(o => {
      if (o === b) return;
      const dx = (b.x + bubbleSize/2) - (o.x + bubbleSize/2);
      const dy = (b.y + bubbleSize/2) - (o.y + bubbleSize/2);
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < bubbleSize) {
        b.vx *= -1;
        b.vy *= -1;
      }
    });
    b.el.style.left = b.x + "px";
    b.el.style.top = b.y + "px";
  });
  requestAnimationFrame(animateBubbles);
}
positionBubbles();
requestAnimationFrame(animateBubbles);

/* OFFLINE STATUS */
const statusText = document.getElementById("statusText");
function updateOnlineStatus() {
  if (navigator.onLine) {
    statusText.textContent = "Online: search and map powered by Google. Offline: you can still create events from custom clicks.";
  } else {
    statusText.textContent = "Offline: map and search may be limited, but you can still click to mark spots and create calendar events.";
  }
}
window.addEventListener("online", updateOnlineStatus);
window.addEventListener("offline", updateOnlineStatus);
updateOnlineStatus();

/* USER CONTEXT */
let user = null;
try {
  user = JSON.parse(localStorage.getItem("rc_user"));
} catch(e) {
  user = null;
}
if (!user) {
  user = { id: "guest_" + Date.now(), username: "Guest" };
}
const OWNER_ID = user.id || user.username || "anonymous";

/* CALENDAR + CHAT HELPERS */
function getCalendarItems() {
  try {
    return JSON.parse(localStorage.getItem("rc_calendar_items") || "[]");
  } catch(e) {
    return [];
  }
}
function saveCalendarItems(items) {
  localStorage.setItem("rc_calendar_items", JSON.stringify(items));
}
function addToCalendar(item) {
  const items = getCalendarItems();
  items.push({
    id: "cal_" + Date.now() + "_" + Math.random().toString(16).slice(2),
    ownerId: OWNER_ID,
    type: item.type || "spot",
    refId: item.refId || null,
    title: item.title || "Untitled",
    date: item.date || null,
    time: item.time || "",
    location: item.location || "",
    distance: item.distance || null,
    link: item.link || "",
    privacy: item.privacy || "public",
    groups: item.groups || [],
    notes: item.notes || ""
  });
  saveCalendarItems(items);
}
function shareToChat(payload) {
  let drafts = [];
  try {
    drafts = JSON.parse(localStorage.getItem("rc_chat_drafts") || "[]");
  } catch(e) {
    drafts = [];
  }
  drafts.push({
    id: "draft_" + Date.now(),
    ownerId: OWNER_ID,
    type: "spot",
    payload,
    createdAt: new Date().toISOString()
  });
  localStorage.setItem("rc_chat_drafts", JSON.stringify(drafts));
}

/* CURRENT SPOT STATE */
let currentSpot = null;
const currentSpotCard = document.getElementById("currentSpotCard");
const currentSpotName = document.getElementById("currentSpotName");
const currentSpotAddress = document.getElementById("currentSpotAddress");
const btnSaveToCalendar = document.getElementById("btnSaveToCalendar");
const btnShareToChat = document.getElementById("btnShareToChat");

function setCurrentSpot(spot) {
  currentSpot = spot;
  if (!spot) {
    currentSpotCard.style.display = "none";
    return;
  }
  currentSpotName.textContent = spot.name || "Custom Spot";
  currentSpotAddress.textContent = spot.address || `${spot.lat.toFixed(5)}, ${spot.lng.toFixed(5)}`;
  currentSpotCard.style.display = "block";
}

/* MODAL CONTROL */
const eventModalBackdrop = document.getElementById("eventModalBackdrop");
const eventSpotSummary = document.getElementById("eventSpotSummary");
const eventTitle = document.getElementById("eventTitle");
const eventDate = document.getElementById("eventDate");
const eventTime = document.getElementById("eventTime");
const eventNotes = document.getElementById("eventNotes");
const eventPrivacy = document.getElementById("eventPrivacy");
const eventGroups = document.getElementById("eventGroups");
const cancelEventBtn = document.getElementById("cancelEventBtn");
const saveEventBtn = document.getElementById("saveEventBtn");

function openEventModalFromSpot() {
  if (!currentSpot) {
    alert("Pick a spot first by searching or clicking on the map.");
    return;
  }
  eventSpotSummary.textContent =
    (currentSpot.name || "Custom Spot") + " ‚Äî " +
    (currentSpot.address || `${currentSpot.lat.toFixed(5)}, ${currentSpot.lng.toFixed(5)}`);

  eventTitle.value = currentSpot.name || "";
  eventDate.value = "";
  eventTime.value = "";
  eventNotes.value = "";
  eventPrivacy.value = "public";
  eventGroups.value = "";

  eventModalBackdrop.style.display = "flex";
}
function closeEventModal() {
  eventModalBackdrop.style.display = "none";
}

btnSaveToCalendar.onclick = openEventModalFromSpot;
cancelEventBtn.onclick = closeEventModal;

saveEventBtn.onclick = () => {
  if (!currentSpot) {
    alert("No spot selected.");
    return;
  }
  const title = eventTitle.value.trim() || currentSpot.name || "Untitled Spot Session";
  const date = eventDate.value;
  const time = eventTime.value;
  if (!date || !time) {
    alert("Please set both date and time.");
    return;
  }
  const notes = eventNotes.value.trim();
  const privacy = eventPrivacy.value;
  const groupsStr = eventGroups.value.trim();
  const groups = groupsStr ? groupsStr.split(",").map(x => x.trim()).filter(Boolean) : [];

  addToCalendar({
    type: "spot",
    refId: currentSpot.id || `${currentSpot.lat},${currentSpot.lng}`,
    title,
    date,
    time,
    location: currentSpot.address || `${currentSpot.lat.toFixed(5)}, ${currentSpot.lng.toFixed(5)}`,
    notes,
    privacy,
    groups,
    link: ""  // could later point to a dedicated spot details page
  });

  alert("Event created and added to your calendar.");
  closeEventModal();
};

btnShareToChat.onclick = () => {
  if (!currentSpot) {
    alert("Pick a spot first.");
    return;
  }
  shareToChat({
    name: currentSpot.name || "Custom Spot",
    address: currentSpot.address || `${currentSpot.lat.toFixed(5)}, ${currentSpot.lng.toFixed(5)}`,
    lat: currentSpot.lat,
    lng: currentSpot.lng
  });
  alert("Spot shared to chat drafts. Open Chatrooms to drop it into a conversation.");
};

/* GOOGLE MAP INIT */
let map;
const cosmicStyle = [
  { elementType:"geometry", stylers:[{color:"#0a0a0a"}] },
  { elementType:"labels.text.fill", stylers:[{color:"#ffffff"}] },
  { elementType:"labels.text.stroke", stylers:[{color:"#000000"}] },
  { featureType:"poi", stylers:[{visibility:"off"}] },
  { featureType:"road", stylers:[{color:"#222"}] },
  { featureType:"water", stylers:[{color:"#111"}] }
];

function initMap() {
  try {
    map = new google.maps.Map(document.getElementById("map"), {
      center:{lat:33.8,lng:-84.3},
      zoom:11,
      styles:cosmicStyle,
      disableDefaultUI:true,
    });

    // CLICK TO DROP CUSTOM SPOT + SET CURRENT SPOT
    map.addListener("click", (e) => {
      const lat = e.latLng.lat();
      const lng = e.latLng.lng();

      new google.maps.marker.AdvancedMarkerElement({
        map,
        position:e.latLng,
        title:"Custom Spot",
      });

      setCurrentSpot({
        id: null,
        name:"Custom Spot",
        address:null,
        lat,
        lng
      });
    });
  } catch(err) {
    console.error("Map init failed:", err);
    document.getElementById("map").innerHTML =
      "<div style='color:#fff;text-align:center;margin-top:40vh;'>Map failed to load. You can still create events from spots later.</div>";
  }
}
window.onload = initMap;

/* USER AVATAR MARKER */
function placeUserMarker(lng,lat){
  const profile = JSON.parse(localStorage.getItem("rc_profile") || "{}");
  const avatar = profile.avatarUrl || "styles/default-avatar.png";

  const el = document.createElement("img");
  el.src = avatar;
  el.style.width="50px";
  el.style.height="50px";
  el.style.borderRadius="50%";
  el.style.boxShadow="0 0 15px rgba(255,255,255,0.9)";

  new google.maps.marker.AdvancedMarkerElement({
    map,
    position:{lat, lng},
    content:el
  });
}

/* USE MY LOCATION */
document.getElementById("locateMe").onclick = () => {
  if (!navigator.geolocation) {
    alert("Geolocation not available.");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    if (map) {
      map.panTo({lat:latitude,lng:longitude});
      map.setZoom(14);
      placeUserMarker(longitude,latitude);
    }
  }, () => {
    alert("Could not get your location.");
  });
};

/* SEARCH FUNCTION */
function runSearch(q){
  if (!navigator.onLine) {
    alert("You appear to be offline. Search may not work, but you can still click the map to mark spots.");
  }
  if (!map || !window.google || !google.maps.places) return;

  const service = new google.maps.places.PlacesService(map);

  const request = {
    query:q,
    fields:["name","geometry","formatted_address","place_id"]
  };

  service.findPlaceFromQuery(request,(results,status)=>{
    if(status !== google.maps.places.PlacesServiceStatus.OK || !results || !results.length) return;

    const spot = results[0];
    map.panTo(spot.geometry.location);
    map.setZoom(14);

    const marker = new google.maps.marker.AdvancedMarkerElement({
      map,
      position:spot.geometry.location,
      title:spot.name
    });

    const infowindow = new google.maps.InfoWindow({
      content:`<strong>${spot.name}</strong><br>${spot.formatted_address || ""}`
    });

    marker.addListener("click", () => infowindow.open({anchor:marker, map}));

    // Set current spot so user can save/share
    setCurrentSpot({
      id: spot.place_id || null,
      name: spot.name,
      address: spot.formatted_address || "",
      lat: spot.geometry.location.lat(),
      lng: spot.geometry.location.lng()
    });
  });
}

document.getElementById("searchInput").addEventListener("keydown",e=>{
  if(e.key==="Enter") runSearch(e.target.value);
});
document.querySelectorAll(".cat-btn").forEach(btn=>{
  btn.onclick=()=>runSearch(btn.dataset.q);
});
</script>

</body>
</html>
