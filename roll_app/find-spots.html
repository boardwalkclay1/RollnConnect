<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Find Spots ‚Äì Roll ‚Äôn Connect</title>
  <link rel="stylesheet" href="styles/style.css"/>

  <!-- GOOGLE MAPS EXTENDED COMPONENT LIBRARY -->
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/@googlemaps/extended-component-library/0.6.11/index.min.js"></script>

  <style>
    body {
      background:#000;
      color:#fff;
      margin:0;
      padding:0;
      font-family:'Inter',sans-serif;
      overflow:hidden;
    }

    /* STARFIELDS */
    .stars1,.stars2,.stars3 {
      position:fixed; inset:0;
      background:url('styles/stars-white.png') repeat;
      z-index:-3;
      pointer-events:none;
    }
    .stars1{opacity:.55;animation:drift1 140s linear infinite;}
    .stars2{opacity:.35;animation:drift2 200s linear infinite;}
    .stars3{opacity:.2; animation:drift3 260s linear infinite;}

    @keyframes drift1{from{background-position:0 0;}to{background-position:0 -5000px;}}
    @keyframes drift2{from{background-position:0 0;}to{background-position:-4000px -2000px;}}
    @keyframes drift3{from{background-position:0 0;}to{background-position:3000px 4000px;}}

    /* SIDEBAR */
    .sidebar {
      position:fixed;
      top:50%;
      left:-260px;
      transform:translateY(-50%);
      width:260px;
      background:rgba(255,255,255,0.08);
      backdrop-filter:blur(25px);
      border-right:1px solid rgba(255,255,255,0.25);
      padding:30px 20px;
      border-radius:0 20px 20px 0;
      box-shadow:10px 0 40px rgba(255,255,255,0.25);
      transition:0.35s ease;
      z-index:9998;
    }
    .sidebar.open { left:0; }

    .nav-header{text-align:center;margin-bottom:30px;}
    .logo-orb{font-size:3rem;margin-bottom:10px;text-shadow:0 0 20px #fff;}
    .nav-title{font-size:1.4rem;font-weight:600;text-shadow:0 0 10px #fff;}

    .nav-links {
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .nav-links a {
      color:#fff;
      text-decoration:none;
      font-size:1.05rem;
      padding:10px 14px;
      border-radius:12px;
      transition:0.25s;
      display:block;
      background:rgba(255,255,255,0.05);
      box-shadow:0 0 12px rgba(255,255,255,0.15);
    }
    .nav-links a:hover {
      background:rgba(255,255,255,0.2);
      transform:translateX(8px);
      box-shadow:0 0 20px rgba(255,255,255,0.4);
    }

    /* BURGER */
    .hamburger {
      position:fixed;
      top:25px;
      left:25px;
      width:40px;
      height:30px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      cursor:pointer;
      z-index:9999;
    }
    .hamburger span {
      height:4px;
      width:100%;
      background:#fff;
      border-radius:4px;
      box-shadow:0 0 12px rgba(255,255,255,0.9);
      transition:0.3s;
    }
    .hamburger.active span:nth-child(1){transform:translateY(13px) rotate(45deg);}
    .hamburger.active span:nth-child(2){opacity:0;}
    .hamburger.active span:nth-child(3){transform:translateY(-13px) rotate(-45deg);}

    /* MAP CONTAINER */
    .map-wrapper {
      position:absolute;
      inset:0;
      z-index:1;
    }
    gmp-map {
      width:100%;
      height:100%;
    }

    /* SEARCH / CONTROL PANEL */
    .search-panel {
      position:fixed;
      top:25px;
      right:25px;
      background:rgba(0,0,0,0.80);
      backdrop-filter:blur(20px);
      padding:18px;
      border-radius:20px;
      box-shadow:0 0 30px rgba(255,255,255,0.3);
      z-index:9999;
      width:340px;
      max-height:90vh;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .panel-title {
      font-size:1rem;
      font-weight:600;
      margin-bottom:4px;
    }

    .map-type-row {
      display:flex;
      gap:6px;
      margin-bottom:4px;
      flex-wrap:wrap;
    }

    .map-type-btn {
      flex:1;
      padding:6px 8px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:0.8rem;
      background:rgba(255,255,255,0.15);
      color:#fff;
    }
    .map-type-btn.active {
      background:#fff;
      color:#000;
    }

    .category-buttons {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }

    .cat-btn {
      padding:6px 10px;
      background:rgba(255,255,255,0.15);
      border-radius:12px;
      cursor:pointer;
      font-size:0.8rem;
      transition:0.25s;
    }
    .cat-btn:hover {
      background:#fff;
      color:#000;
      transform:scale(1.05);
    }

    .loc-btn {
      margin-top:4px;
      width:100%;
      padding:8px;
      background:#fff;
      color:#000;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      transition:0.25s;
      border:none;
      font-size:0.9rem;
    }
    .loc-btn:hover {
      transform:scale(1.03);
      box-shadow:0 0 20px rgba(255,255,255,0.8);
    }

    .status-text {
      margin-top:4px;
      font-size:0.75rem;
      opacity:0.85;
    }

    /* RESULTS LIST */
    .results-list {
      margin-top:4px;
      padding:6px;
      border-radius:12px;
      background:rgba(255,255,255,0.05);
      max-height:140px;
      overflow-y:auto;
      font-size:0.8rem;
    }
    .result-item {
      padding:6px;
      border-radius:8px;
      cursor:pointer;
    }
    .result-item:hover {
      background:rgba(255,255,255,0.15);
    }
    .result-name { font-weight:600; }
    .result-address { opacity:0.8; }

    /* CURRENT SPOT CARD */
    .current-spot {
      margin-top:6px;
      padding:10px;
      border-radius:12px;
      background:rgba(255,255,255,0.08);
      font-size:0.8rem;
    }
    .current-spot-title {
      font-weight:600;
      margin-bottom:2px;
    }
    .current-spot-meta {
      opacity:0.9;
      margin-bottom:4px;
    }
    .current-spot-actions {
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .btn-small {
      padding:6px 10px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:0.75rem;
    }
    .btn-primary {
      background:#fff;
      color:#000;
    }
    .btn-ghost {
      background:rgba(255,255,255,0.15);
      color:#fff;
    }

    /* PRESENCE + REVIEWS */
    .presence-section,
    .reviews-section {
      margin-top:8px;
      padding-top:6px;
      border-top:1px solid rgba(255,255,255,0.1);
      font-size:0.75rem;
    }
    .presence-list,
    .reviews-list {
      max-height:80px;
      overflow-y:auto;
      margin-top:4px;
    }
    .presence-user {
      padding:3px 0;
    }
    .presence-user a {
      color:#fff;
      text-decoration:underline;
      font-size:0.75rem;
    }
    .review-item {
      padding:3px 0;
    }

    .review-form textarea {
      width:100%;
      padding:6px;
      border-radius:8px;
      border:none;
      background:rgba(255,255,255,0.15);
      color:#fff;
      font-size:0.75rem;
      resize:vertical;
      min-height:40px;
      margin-top:4px;
    }
    .review-form button {
      margin-top:4px;
      padding:4px 10px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:0.75rem;
      background:#fff;
      color:#000;
    }

    /* MODAL */
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10000;
    }
    .modal {
      background:rgba(0,0,0,0.9);
      border-radius:18px;
      padding:20px;
      max-width:360px;
      width:90%;
      box-shadow:0 0 30px rgba(255,255,255,0.4);
    }
    .modal h2 {
      margin-top:0;
      margin-bottom:10px;
      font-size:1.3rem;
    }
    .modal label {
      display:block;
      font-size:0.85rem;
      margin:8px 0 4px;
    }
    .modal input,
    .modal textarea,
    .modal select {
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:none;
      background:rgba(255,255,255,0.15);
      color:#fff;
      font-size:0.85rem;
    }
    .modal textarea {
      resize:vertical;
      min-height:60px;
    }
    .modal-actions {
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .modal-actions button {
      padding:7px 12px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:0.85rem;
    }
    .modal-save { background:#fff; color:#000; }
    .modal-cancel { background:rgba(255,255,255,0.2); color:#fff; }
  </style>
</head>

<body>

<div class="stars1"></div>
<div class="stars2"></div>
<div class="stars3"></div>

<!-- BURGER -->
<div id="hamburger" class="hamburger"><span></span><span></span><span></span></div>

<!-- SIDEBAR -->
<nav id="sidebar" class="sidebar">
  <div class="nav-header">
    <div class="logo-orb">üìç</div>
    <div class="nav-title">Find Spots</div>
  </div>

  <ul class="nav-links">
    <li><a href="dashboard.html">üìä Dashboard</a></li>
    <li><a href="chatrooms.html">üí¨ Chatrooms</a></li>
    <li><a href="events.html">üìÖ Events</a></li>
    <li><a href="calendar.html">üóìÔ∏è Calendar</a></li>
    <li><a href="profile.html">üë§ Your Profile</a></li>
    <li><a href="profile-edit.html">‚úèÔ∏è Edit Profile</a></li>
    <li><a href="settings.html">‚öôÔ∏è Settings</a></li>
  </ul>
</nav>

<!-- MAP + COMPONENTS -->
<gmpx-api-loader
  key="AIzaSyB02c_eleXuhHWdSMJzqk9mESbXn_PT2zc"
  solution-channel="ROLLNCONNECT_FINDSPOTS_V2">
</gmpx-api-loader>

<div class="map-wrapper">
  <gmp-map id="rnMap"
    center="33.8000,-84.3000"
    zoom="11"
    map-id="DEMO_MAP_ID">
    <div slot="control-block-start-inline-start" class="place-picker-container">
      <gmpx-place-picker id="placePicker" placeholder="Search for a spot"></gmpx-place-picker>
    </div>
    <gmp-advanced-marker id="selectedMarker"></gmp-advanced-marker>
  </gmp-map>
</div>

<!-- CONTROL PANEL -->
<div class="search-panel">
  <div class="panel-title">Find Spots</div>

  <div class="map-type-row">
    <button class="map-type-btn active" id="btnTypeStreet">Street</button>
    <button class="map-type-btn" id="btnTypeSatellite">Satellite</button>
    <button class="map-type-btn" id="btnTypeTrail">Trail</button>
  </div>

  <div class="category-buttons">
    <div class="cat-btn" data-type="skatepark">Skateparks</div>
    <div class="cat-btn" data-type="park">Parks</div>
    <div class="cat-btn" data-type="rink">Rinks</div>
    <div class="cat-btn" data-type="trail">Trails</div>
    <div class="cat-btn" data-type="parking">Parking Lots</div>
    <div class="cat-btn" data-type="plaza">Plazas</div>
    <div class="cat-btn" data-type="water">Water</div>
    <div class="cat-btn" data-type="food">Food</div>
  </div>

  <button class="loc-btn" id="locateMe">Use My Location</button>

  <div class="status-text" id="statusText">
    Online: live places around your view. Offline: you can still click the map and create calendar events.
  </div>

  <!-- RESULTS -->
  <div class="results-list" id="resultsList">
    <div style="opacity:0.8;">Use filters or search to see nearby spots.</div>
  </div>

  <!-- CURRENT SPOT CARD -->
  <div class="current-spot" id="currentSpotCard" style="display:none;">
    <div class="current-spot-title" id="currentSpotName"></div>
    <div class="current-spot-meta" id="currentSpotAddress"></div>

    <div class="current-spot-actions">
      <button class="btn-small btn-primary" id="btnSaveToCalendar">Add to Calendar</button>
      <button class="btn-small btn-ghost" id="btnShareToChat">Share to Chat</button>
      <button class="btn-small btn-ghost" id="btnMarkHere">I‚Äôm here</button>
    </div>

    <div class="presence-section">
      <strong>People here now</strong>
      <div class="presence-list" id="presenceList"></div>
    </div>

    <div class="reviews-section">
      <strong>Reviews</strong>
      <div class="reviews-list" id="reviewsList"></div>
      <div class="review-form">
        <textarea id="reviewInput" placeholder="Drop a quick review..."></textarea>
        <button id="reviewSubmit">Post Review</button>
      </div>
    </div>
  </div>
</div>

<!-- EVENT MODAL -->
<div class="modal-backdrop" id="eventModalBackdrop">
  <div class="modal" id="eventModal">
    <h2>Create Calendar Event</h2>
    <p style="font-size:0.85rem;opacity:0.9;" id="eventSpotSummary"></p>

    <label for="eventTitle">Title / Reason</label>
    <input id="eventTitle" placeholder="Night session, practice run, meetup...">

    <label for="eventDate">Date</label>
    <input id="eventDate" type="date">

    <label for="eventTime">Time</label>
    <input id="eventTime" type="time">

    <label for="eventNotes">Notes</label>
    <textarea id="eventNotes" placeholder="What are you planning to do here?"></textarea>

    <label for="eventPrivacy">Privacy</label>
    <select id="eventPrivacy">
      <option value="public">Public</option>
      <option value="private">Private</option>
      <option value="groups">Groups</option>
    </select>

    <label for="eventGroups">Groups (comma separated, if using groups)</label>
    <input id="eventGroups" placeholder="Crew, Squad, Meetup name...">

    <div class="modal-actions">
      <button class="modal-cancel" id="cancelEventBtn">Cancel</button>
      <button class="modal-save" id="saveEventBtn">Save Event</button>
    </div>
  </div>
</div>

<script>
/* BURGER + SIDEBAR */
const h = document.getElementById("hamburger");
const s = document.getElementById("sidebar");
h.onclick = () => {
  h.classList.toggle("active");
  s.classList.toggle("open");
};

/* OFFLINE STATUS */
const statusText = document.getElementById("statusText");
function updateOnlineStatus() {
  if (navigator.onLine) {
    statusText.textContent = "Online: live places around your view. Offline: you can still click the map and create calendar events.";
  } else {
    statusText.textContent = "Offline: map tiles/search may be limited, but you can still click to mark spots and create calendar events.";
  }
}
window.addEventListener("online", updateOnlineStatus);
window.addEventListener("offline", updateOnlineStatus);
updateOnlineStatus();

/* USER CONTEXT */
let user = null;
try { user = JSON.parse(localStorage.getItem("rc_user")); } catch(e) { user = null; }
if (!user) user = { id:"guest_" + Date.now(), username:"Guest" };
const OWNER_ID = user.id || user.username || "anonymous";

/* CALENDAR + CHAT HELPERS */
function getCalendarItems() {
  try { return JSON.parse(localStorage.getItem("rc_calendar_items") || "[]"); }
  catch(e){ return []; }
}
function saveCalendarItems(items) {
  localStorage.setItem("rc_calendar_items", JSON.stringify(items));
}
function addToCalendar(item) {
  const items = getCalendarItems();
  items.push({
    id: "cal_" + Date.now() + "_" + Math.random().toString(16).slice(2),
    ownerId: OWNER_ID,
    type: item.type || "spot",
    refId: item.refId || null,
    title: item.title || "Untitled",
    date: item.date || null,
    time: item.time || "",
    location: item.location || "",
    distance: item.distance || null,
    link: item.link || "",
    privacy: item.privacy || "public",
    groups: item.groups || [],
    notes: item.notes || ""
  });
  saveCalendarItems(items);
}

function shareToChat(payload) {
  let drafts = [];
  try { drafts = JSON.parse(localStorage.getItem("rc_chat_drafts") || "[]"); }
  catch(e){ drafts = []; }
  drafts.push({
    id: "draft_" + Date.now(),
    ownerId: OWNER_ID,
    type: "spot",
    payload,
    createdAt: new Date().toISOString()
  });
  localStorage.setItem("rc_chat_drafts", JSON.stringify(drafts));
}

/* PRESENCE + REVIEWS HELPERS (LOCAL FOR NOW, BACKEND READY) */
function getSpotPresence(spotId) {
  try { return JSON.parse(localStorage.getItem("rc_spot_presence") || "{}")[spotId] || []; }
  catch(e){ return []; }
}
function setSpotPresence(spotId, list) {
  let all = {};
  try { all = JSON.parse(localStorage.getItem("rc_spot_presence") || "{}"); }
  catch(e){ all = {}; }
  all[spotId] = list;
  localStorage.setItem("rc_spot_presence", JSON.stringify(all));
}

function getSpotReviews(spotId) {
  try { return JSON.parse(localStorage.getItem("rc_spot_reviews") || "{}")[spotId] || []; }
  catch(e){ return []; }
}
function setSpotReviews(spotId, list) {
  let all = {};
  try { all = JSON.parse(localStorage.getItem("rc_spot_reviews") || "{}"); }
  catch(e){ all = {}; }
  all[spotId] = list;
  localStorage.setItem("rc_spot_reviews", JSON.stringify(all));
}

/* CURRENT SPOT STATE */
let currentSpot = null;
const currentSpotCard = document.getElementById("currentSpotCard");
const currentSpotName = document.getElementById("currentSpotName");
const currentSpotAddress = document.getElementById("currentSpotAddress");
const presenceList = document.getElementById("presenceList");
const reviewsList = document.getElementById("reviewsList");
const reviewInput = document.getElementById("reviewInput");
const reviewSubmit = document.getElementById("reviewSubmit");
const btnSaveToCalendar = document.getElementById("btnSaveToCalendar");
const btnShareToChat = document.getElementById("btnShareToChat");
const btnMarkHere = document.getElementById("btnMarkHere");

function renderPresence(spotId) {
  presenceList.innerHTML = "";
  const presence = getSpotPresence(spotId);
  if (!presence.length) {
    presenceList.innerHTML = "<div style='opacity:0.7;'>No one has marked themselves here yet.</div>";
    return;
  }
  presence.forEach(p => {
    const div = document.createElement("div");
    div.className = "presence-user";
    const profileUrl = `profile.html?user=${encodeURIComponent(p.userId)}`;
    div.innerHTML = `<a href="${profileUrl}">${p.username || "User"}</a> <span style="opacity:0.7;">(${new Date(p.timestamp).toLocaleTimeString()})</span>`;
    presenceList.appendChild(div);
  });
}

function renderReviews(spotId) {
  reviewsList.innerHTML = "";
  const reviews = getSpotReviews(spotId);
  if (!reviews.length) {
    reviewsList.innerHTML = "<div style='opacity:0.7;'>No reviews yet.</div>";
    return;
  }
  reviews.forEach(r => {
    const div = document.createElement("div");
    div.className = "review-item";
    div.innerHTML = `<strong>${r.username || "User"}:</strong> ${r.text}`;
    reviewsList.appendChild(div);
  });
}

function setCurrentSpot(spot) {
  currentSpot = spot;
  if (!spot) {
    currentSpotCard.style.display = "none";
    return;
  }
  currentSpotName.textContent = spot.name || "Custom Spot";
  currentSpotAddress.textContent = spot.address || `${spot.lat.toFixed(5)}, ${spot.lng.toFixed(5)}`;
  currentSpotCard.style.display = "block";
  const spotId = spot.id || `${spot.lat},${spot.lng}`;
  renderPresence(spotId);
  renderReviews(spotId);
}

/* MODAL CONTROL */
const eventModalBackdrop = document.getElementById("eventModalBackdrop");
const eventSpotSummary = document.getElementById("eventSpotSummary");
const eventTitle = document.getElementById("eventTitle");
const eventDate = document.getElementById("eventDate");
const eventTime = document.getElementById("eventTime");
const eventNotes = document.getElementById("eventNotes");
const eventPrivacy = document.getElementById("eventPrivacy");
const eventGroups = document.getElementById("eventGroups");
const cancelEventBtn = document.getElementById("cancelEventBtn");
const saveEventBtn = document.getElementById("saveEventBtn");

function openEventModalFromSpot() {
  if (!currentSpot) {
    alert("Pick a spot first by searching or clicking on the map.");
    return;
  }
  eventSpotSummary.textContent =
    (currentSpot.name || "Custom Spot") + " ‚Äî " +
    (currentSpot.address || `${currentSpot.lat.toFixed(5)}, ${currentSpot.lng.toFixed(5)}`);

  eventTitle.value = currentSpot.name || "";
  eventDate.value = "";
  eventTime.value = "";
  eventNotes.value = "";
  eventPrivacy.value = "public";
  eventGroups.value = "";

  eventModalBackdrop.style.display = "flex";
}
function closeEventModal() {
  eventModalBackdrop.style.display = "none";
}

btnSaveToCalendar.onclick = openEventModalFromSpot;
cancelEventBtn.onclick = closeEventModal;

saveEventBtn.onclick = () => {
  if (!currentSpot) {
    alert("No spot selected.");
    return;
  }
  const title = eventTitle.value.trim() || currentSpot.name || "Untitled Spot Session";
  const date = eventDate.value;
  const time = eventTime.value;
  if (!date || !time) {
    alert("Please set both date and time.");
    return;
  }
  const notes = eventNotes.value.trim();
  const privacy = eventPrivacy.value;
  const groupsStr = eventGroups.value.trim();
  const groups = groupsStr ? groupsStr.split(",").map(x => x.trim()).filter(Boolean) : [];
  const locString = currentSpot.address || `${currentSpot.lat.toFixed(5)}, ${currentSpot.lng.toFixed(5)}`;
  const spotId = currentSpot.id || `${currentSpot.lat},${currentSpot.lng}`;

  addToCalendar({
    type: "spot",
    refId: spotId,
    title,
    date,
    time,
    location: locString,
    notes,
    privacy,
    groups,
    link: ""
  });

  alert("Event created and added to your calendar.");
  closeEventModal();
};

btnShareToChat.onclick = () => {
  if (!currentSpot) {
    alert("Pick a spot first.");
    return;
  }
  const payload = {
    name: currentSpot.name || "Custom Spot",
    address: currentSpot.address || `${currentSpot.lat.toFixed(5)}, ${currentSpot.lng.toFixed(5)}`,
    lat: currentSpot.lat,
    lng: currentSpot.lng
  };
  shareToChat(payload);
  alert("Spot shared to chat drafts. Open Chatrooms to drop it into a conversation.");
};

btnMarkHere.onclick = () => {
  if (!currentSpot) {
    alert("Pick a spot first.");
    return;
  }
  const spotId = currentSpot.id || `${currentSpot.lat},${currentSpot.lng}`;
  let presence = getSpotPresence(spotId);
  const existingIndex = presence.findIndex(p => p.userId === OWNER_ID);
  const entry = {
    userId: OWNER_ID,
    username: user.username || "User",
    timestamp: new Date().toISOString()
  };
  if (existingIndex >= 0) presence[existingIndex] = entry;
  else presence.push(entry);
  setSpotPresence(spotId, presence);
  renderPresence(spotId);
};

/* REVIEW SUBMIT */
reviewSubmit.onclick = () => {
  if (!currentSpot) {
    alert("Pick a spot first.");
    return;
  }
  const text = reviewInput.value.trim();
  if (!text) return;
  const spotId = currentSpot.id || `${currentSpot.lat},${currentSpot.lng}`;
  let reviews = getSpotReviews(spotId);
  reviews.push({
    userId: OWNER_ID,
    username: user.username || "User",
    text,
    timestamp: new Date().toISOString()
  });
  setSpotReviews(spotId, reviews);
  reviewInput.value = "";
  renderReviews(spotId);
};

/* MAP + COMPONENTS (WEB COMPONENTS) */
let innerMap = null;
let placesService = null;
let currentMarkers = [];
const resultsList = document.getElementById("resultsList");

const cosmicStyle = [
  { elementType:"geometry", stylers:[{color:"#0a0a0a"}] },
  { elementType:"labels.text.fill", stylers:[{color:"#ffffff"}] },
  { elementType:"labels.text.stroke", stylers:[{color:"#000000"}] },
  { featureType:"poi", stylers:[{visibility:"off"}] },
  { featureType:"road", stylers:[{color:"#111"}] },
  { featureType:"road", elementType:"labels.icon", stylers:[{visibility:"off"}] },
  { featureType:"water", stylers:[{color:"#111"}] }
];

function clearMarkers() {
  currentMarkers.forEach(m => m.setMap(null));
  currentMarkers = [];
}

function renderResults(results) {
  resultsList.innerHTML = "";
  if (!results.length) {
    resultsList.innerHTML = "<div style='opacity:0.8;'>No spots found here. Try moving the map or changing filters.</div>";
    return;
  }
  results.forEach((r, idx) => {
    const div = document.createElement("div");
    div.className = "result-item";
    div.innerHTML = `
      <div class="result-name">${r.name}</div>
      <div class="result-address">${r.vicinity || r.formatted_address || ""}</div>
    `;
    div.onclick = () => {
      if (!innerMap) return;
      innerMap.panTo(r.geometry.location);
      innerMap.setZoom(15);
      const spot = {
        id: r.place_id || null,
        name: r.name,
        address: r.vicinity || r.formatted_address || "",
        lat: r.geometry.location.lat(),
        lng: r.geometry.location.lng()
      };
      setCurrentSpot(spot);
    };
    resultsList.appendChild(div);
  });
}

function runCategorySearch(typeKey) {
  if (!innerMap || !placesService) return;
  if (!navigator.onLine) {
    alert("You appear to be offline. Category search needs internet, but you can still click the map.");
    return;
  }
  const center = innerMap.getCenter();
  const location = { lat: center.lat(), lng: center.lng() };

  let request = {
    location,
    radius: 4000,
    rankBy: google.maps.places.RankBy.PROMINENCE
  };

  switch (typeKey) {
    case "skatepark":
      request.keyword = "skatepark";
      request.type = "park";
      break;
    case "park":
      request.type = "park";
      break;
    case "rink":
      request.keyword = "roller rink";
      request.type = "establishment";
      break;
    case "trail":
      request.keyword = "trail";
      request.type = "park";
      break;
    case "parking":
      request.type = "parking";
      break;
    case "plaza":
      request.keyword = "plaza";
      request.type = "establishment";
      break;
    case "water":
      request.keyword = "lake OR river OR waterfront";
      request.type = "tourist_attraction";
      break;
    case "food":
      request.type = "restaurant";
      break;
    default:
      request.type = "point_of_interest";
  }

  placesService.nearbySearch(request, (results, status) => {
    if (status !== google.maps.places.PlacesServiceStatus.OK || !results) {
      renderResults([]);
      return;
    }
    clearMarkers();
    results.forEach(r => {
      const marker = new google.maps.marker.AdvancedMarkerElement({
        map: innerMap,
        position: r.geometry.location,
        title: r.name
      });
      marker.addListener("click", () => {
        const spot = {
          id: r.place_id || null,
          name: r.name,
          address: r.vicinity || r.formatted_address || "",
          lat: r.geometry.location.lat(),
          lng: r.geometry.location.lng()
        };
        setCurrentSpot(spot);
      });
      currentMarkers.push(marker);
    });
    renderResults(results);
  });
}

/* MAP INIT */
customElements.whenDefined("gmp-map").then(() => {
  const mapEl = document.getElementById("rnMap");
  innerMap = mapEl.innerMap;

  if (window.google && google.maps && google.maps.places) {
    placesService = new google.maps.places.PlacesService(innerMap);
  } else {
    // Wait for API just in case
    const wait = setInterval(() => {
      if (window.google && google.maps && google.maps.places) {
        placesService = new google.maps.places.PlacesService(innerMap);
        clearInterval(wait);
      }
    }, 200);
  }

  // Cosmic styling
  innerMap.setOptions({styles: cosmicStyle, mapTypeId: "roadmap"});

  // Click-to-create custom spot
  innerMap.addListener("click", e => {
    const lat = e.latLng.lat();
    const lng = e.latLng.lng();
    const marker = new google.maps.marker.AdvancedMarkerElement({
      map: innerMap,
      position: e.latLng,
      title: "Custom Spot"
    });
    currentMarkers.push(marker);
    setCurrentSpot({
      id: null,
      name: "Custom Spot",
      address: null,
      lat,
      lng
    });
  });
});

/* PLACE PICKER */
customElements.whenDefined("gmpx-place-picker").then(() => {
  const placePicker = document.getElementById("placePicker");
  const selectedMarker = document.getElementById("selectedMarker");

  placePicker.addEventListener("gmpx-placechange", () => {
    const place = placePicker.value;
    if (!place || !place.location || !innerMap) return;

    innerMap.panTo(place.location);
    innerMap.setZoom(15);

    selectedMarker.position = place.location;
    selectedMarker.title = place.displayName || "Selected Spot";

    const spot = {
      id: place.id || null,
      name: place.displayName || "Selected Spot",
      address: place.formattedAddress || "",
      lat: place.location.lat(),
      lng: place.location.lng()
    };
    setCurrentSpot(spot);
  });
});

/* CATEGORY BUTTONS */
document.querySelectorAll(".cat-btn").forEach(btn => {
  btn.onclick = () => {
    const key = btn.dataset.type;
    runCategorySearch(key);
  };
});

/* MAP TYPE SWITCHER */
const btnTypeStreet = document.getElementById("btnTypeStreet");
const btnTypeSatellite = document.getElementById("btnTypeSatellite");
const btnTypeTrail = document.getElementById("btnTypeTrail");
function setMapType(type) {
  if (!innerMap) return;
  btnTypeStreet.classList.remove("active");
  btnTypeSatellite.classList.remove("active");
  btnTypeTrail.classList.remove("active");

  if (type === "street") {
    btnTypeStreet.classList.add("active");
    innerMap.setMapTypeId("roadmap");
    innerMap.setOptions({styles: cosmicStyle});
  } else if (type === "satellite") {
    btnTypeSatellite.classList.add("active");
    innerMap.setMapTypeId("satellite");
    innerMap.setOptions({styles: null});
  } else if (type === "trail") {
    btnTypeTrail.classList.add("active");
    innerMap.setMapTypeId("terrain");
    innerMap.setOptions({styles: null});
  }
}
btnTypeStreet.onclick = () => setMapType("street");
btnTypeSatellite.onclick = () => setMapType("satellite");
btnTypeTrail.onclick = () => setMapType("trail");

/* USE MY LOCATION */
document.getElementById("locateMe").onclick = () => {
  if (!navigator.geolocation) {
    alert("Geolocation not available.");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    const {latitude, longitude} = pos.coords;
    if (innerMap) {
      innerMap.panTo({lat:latitude, lng:longitude});
      innerMap.setZoom(14);
      const marker = new google.maps.marker.AdvancedMarkerElement({
        map: innerMap,
        position: {lat:latitude, lng:longitude},
        title: "You are here"
      });
      currentMarkers.push(marker);
      setCurrentSpot({
        id: "user:" + OWNER_ID,
        name: "Current Location",
        address: null,
        lat: latitude,
        lng: longitude
      });
    }
  }, () => {
    alert("Could not get your location.");
  });
};
</script>

</body>
</html>
